<!DOCTYPE html>


<html lang="en">


<head>
  <meta charset="utf-8" />
    
  <meta name="description" content="一枚小菜鸡~" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
     Syraer&#39;s Blog
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
  
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

  
  

  

</head>

</html>

<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover2.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">Syraer&#39;s Blog</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
        <img
          src="/images/ayer.svg"
          class="cover-logo"
          alt="Syraer&#39;s Blog"
        />
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['面朝大海，春暖花开', '愿你一生努力，一生被爱', '想要的都拥有，得不到的都释怀'],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  

<div class="notice" style="margin-top:50px">
    <i class="ri-heart-fill"></i>
    <div class="notice-content" id="broad"></div>
</div>
<script type="text/javascript">
    fetch('https://v1.hitokoto.cn')
        .then(response => response.json())
        .then(data => {
            document.getElementById("broad").innerHTML = data.hitokoto;
        })
        .catch(console.error)
</script>

<style>
    .notice {
        padding: 20px;
        border: 1px dashed #e6e6e6;
        color: #969696;
        position: relative;
        display: inline-block;
        width: 100%;
        background: #fbfbfb50;
        border-radius: 10px;
    }

    .notice i {
        float: left;
        color: #999;
        font-size: 16px;
        padding-right: 10px;
        vertical-align: middle;
        margin-top: -2px;
    }

    .notice-content {
        display: initial;
        vertical-align: middle;
    }
</style>
  
  <article class="articles">
    
    
    
    
    <article
  id="post-Geth_note"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/29/Geth_note/"
    >Geth_搭建私有链</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/29/Geth_note/" class="article-date">
  <time datetime="2020-11-29T10:32:14.000Z" itemprop="datePublished">2020-11-29</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/BlockChain/">BlockChain</a> / <a class="article-category-link" href="/categories/BlockChain/Geth/">Geth</a> / <a class="article-category-link" href="/categories/BlockChain/Geth/MetaMask/">MetaMask</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>MetaMask_pass:spot raccoon network sweet feel song knee put just uncover news audit //我的MetaMask助记词 ；可以直接用Remix-IDE连接geth，也可以通过MetaMask连接Geth，这样MetaMask帮助你实现r s v ，不用自己去弄！</p>
<p>Geth客户端：<a target="_blank" rel="noopener" href="https://geth.ethereum.org/downloads/">Geth_download</a></p>
<h3 id="Part0-MetaMask"><a href="#Part0-MetaMask" class="headerlink" title="Part0 MetaMask"></a>Part0 MetaMask</h3><p><img src="/2020/11/29/Geth_note/1606643269702.png" alt="1"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#通过MetaMask连接本地Geth或者Ganache搭建的私有链或者TestRPC等都可以，这样会比较方便查看部署的合约和交易信息，而且更贴合实际操作。</span><br><span class="line">#如果不想搭建私有链，可以通过测试网络去部署合约和交易也是可以的，但是首先需要从对应的测试网络水龙头获取ether操作及之后测试需要科学上网。</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在本地通过npm安装一个remixd，这样可以实时将本地和浏览器代码同步，方便存储代码。<code>npm install remixd -g</code></p>
<p><img src="/2020/11/29/Geth_note/1606643713320.png" alt="2"></p>
</li>
<li><p>部署合约和测试合约</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#智能合约</span><br><span class="line">#Solidity编译器是solc，通过remix-ide编写合约时候，注意solc的版本  </span><br><span class="line">#pragma solidity &gt;<span class="number">0.6</span><span class="number">.2</span> 也可以，当版本出现错误时候，可以尝试改变编译版本</span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.2</span>;</span><br><span class="line"></span><br><span class="line">contract Test&#123;</span><br><span class="line">    <span class="comment">//contract balance</span></span><br><span class="line">    uint public  money  ;</span><br><span class="line">    <span class="comment">//在remix中修改value 运行paly，金额就转到合约当中去了，然后通过transfer转到其他账户中去</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">paly</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span></span>&#123;</span><br><span class="line">        money = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//contract balance </span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getBalance</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint256</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> address(<span class="built_in">this</span>).balance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    address payable addr =  <span class="number">0x78662A9CFfFc852cF61a5c6c637cFB93f1c59397</span>;</span><br><span class="line">    <span class="comment">//transfer who ,who call </span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">uint i </span>) <span class="title">public</span> <span class="title">payable</span>  </span>&#123;</span><br><span class="line">        addr.transfer ( i * <span class="number">10</span> ** <span class="number">18</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>接种编写合约的方式</p>
<ul>
<li>VS code IDE,代码编写,基本的语法检查.</li>
<li>Remix IDE,简单代码编译运行看结果.方便学习.</li>
<li>Truffle 环境,生产环境,较为复杂的代码编译部署.</li>
</ul>
</li>
<li><p>ENVIRONMENT</p>
<ul>
<li>JavaScriptVM<ul>
<li>该方式环境是将合约部署到浏览器的Solidity编译环境，可以在内存中模拟合约,直接运行,而不需要部署等复杂流程,适合入门学习.</li>
</ul>
</li>
<li>Injected Web3<ul>
<li>该方式可以连接到MetaMask.</li>
</ul>
</li>
<li>Web3 Provider<ul>
<li>该方式通过本地私有网络的rpc端口,链接到本地私有网络进行调试.</li>
</ul>
</li>
</ul>
</li>
<li><p>Deployed Contracts</p>
<ul>
<li>可以看到已经部署的合约，此时就可以看到在合约中写的相应get-set函数和public的状态变量;</li>
<li>可以进行智能合约回调，当且只有产生新的数据才会发生交易，否则仅仅是调用，而不会产生新的交易区块.</li>
</ul>
</li>
</ul>
<p><img src="/2020/11/29/Geth_note/1606643984807.png" alt="3"></p>
<h3 id="Part1-Geth入门"><a href="#Part1-Geth入门" class="headerlink" title="Part1 Geth入门"></a>Part1 Geth入门</h3><ul>
<li>创世块</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;config&quot;</span>: &#123;</span><br><span class="line">	<span class="attr">&quot;chainId&quot;</span>: <span class="number">15</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">&quot;difficulty&quot;</span>: <span class="string">&quot;2000&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;gasLimit&quot;</span>: <span class="string">&quot;2100000&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;alloc&quot;</span>: &#123;</span><br><span class="line">		<span class="attr">&quot;7df9a875a174b3bc565e6424a0050ebc1b2d1d82&quot;</span>: &#123; <span class="attr">&quot;balance&quot;</span>: <span class="string">&quot;300000000000000000000&quot;</span> &#125;,</span><br><span class="line">		<span class="attr">&quot;f41c74c9ae680c1aa78f42e5647a62f353b7bdde&quot;</span>: &#123; <span class="attr">&quot;balance&quot;</span>: <span class="string">&quot;400000000000000000000&quot;</span> &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化创世快</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">D:\gethData&gt;geth --datadir . init genesis.json</span><br><span class="line">	此时在testGeth目录下会生成data目录，data目录又包含geth和keystore目录，geth目录存储区块数据，keystore目录则保存账户信息。</span><br><span class="line">	--init #根据genesis.json文件初始化创世区块</span><br></pre></td></tr></table></figure>

<ul>
<li>启动geth并开启远程RPC然后log输出到output.log里面</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">D:\gethData&gt;geth --datadir ./data0/ --rpc --rpccorsdomain <span class="string">&quot;*&quot;</span> --rpcaddr <span class="string">&quot;0.0.0.0&quot;</span> --rpcapi <span class="string">&quot;personal,admin,miner,db,eth,net,web3&quot;</span> --ipcdisable  --nodiscover  --allow-insecure-unlock --networkid 15 console 2&gt;&gt; output.log</span><br><span class="line">D:\gethData&gt;geth --datadir <span class="string">&quot;./data0/&quot;</span> --nodiscover  --ipcdisable   --port 3333    --rpc   --rpcport 4444    --rpcapi=<span class="string">&quot;db,eth,net,web3,personal&quot;</span>   --allow-insecure-unlock   --rpccorsdomain=<span class="string">&quot;http://remix.ethereum.org&quot;</span>   --networkid 1314     console 2&gt;output.log</span><br><span class="line">		--datadir <span class="comment">#指定数据存储位置（也是默认的私钥仓库位置keystore）</span></span><br><span class="line">		--networkid 123<span class="comment">#参数表示区块链网络ID标识，</span></span><br><span class="line">		--console <span class="comment">#参数表示进入geth控制台。</span></span><br><span class="line">		--rpc <span class="comment">#启动HTTP-RPC服务（基于HTTP的）</span></span><br><span class="line">		--rpcapi <span class="comment">#远程可调用的功能，默认web3,net,eth。4.24版本必须添加personal，否则remix无法读取本地账户列表；4.24版本testrpc也是无法读取用户列表。</span></span><br><span class="line">		--rpccorsdomain <span class="comment">#指定一个可以接收请求来源的以逗号间隔的域名列表（浏览器访问的话，要强制指定该选项）</span></span><br><span class="line">		--rpcaddr <span class="comment"># HTTP-RPC服务器监听地址(default: &quot;localhost&quot;)</span></span><br><span class="line">		--rpcport <span class="string">&quot;8545&quot;</span> <span class="comment">#设置geth的端口号，默认为8545</span></span><br><span class="line">		--port <span class="string">&quot;30303&quot;</span> <span class="comment">#设置监听端口号，用于与其他按节点进行连接，默认30303</span></span><br><span class="line">		--identity <span class="string">&quot;TestNetMainNode&quot;</span> <span class="comment">#设置节点标识</span></span><br><span class="line">		--ipcdiscover <span class="comment">#关闭进程间通信</span></span><br><span class="line">		--maxpeers 0 <span class="comment">#设置网络中可以被接入的最大节点数目，0代表不被其他节点接入</span></span><br><span class="line">		--nodiscover <span class="comment">#私有链,不被别人添加</span></span><br><span class="line">		--allow-insecure-unlock  <span class="comment">#禁止了HTTP通道解锁账户</span></span><br><span class="line">		--2&gt;&gt; output.log <span class="comment">#错误追加输出到output.log(所有信息不管错误和正确都输出到文件中)</span></span><br><span class="line">		<span class="comment">#连接测试网进入控制台，此时我们已经进入geth测试网的交互式控制台，窗口也显示「Welcome to the Geth JavaScript console」成功提示！</span></span><br><span class="line"><span class="comment">#注意： </span></span><br><span class="line"><span class="comment">#https://blog.csdn.net/qq_32938169 #某位大佬博客</span></span><br><span class="line"><span class="comment">#在当前目录下运行 geth，就会启动这条私链，注意要将 networked 设置为与创世块配置里的chainId 一致。</span></span><br><span class="line"><span class="comment">#异常：使用最新版本geth客户，当执行personal.unlockAccount()或在程序中调用personal_unlockAccount接口时，会出现：account unlock with HTTP access is forbidden异常。</span></span><br><span class="line"><span class="comment">#异常原因：新版本geth，出于安全考虑，默认禁止了HTTP通道解锁账户，相关issue：https://github.com/ethereum/go-ethereum/pull/17037</span></span><br></pre></td></tr></table></figure>

<ul>
<li>发送一比交易：</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">personal.sendTransaction(&#123;<span class="attr">from</span>: <span class="string">&quot;0xaC58C330aC8fF04fF828684d3FFABEFE987de7cb&quot;</span> , <span class="attr">to</span>: eth.accounts[<span class="number">0</span>] , <span class="attr">value</span>: web3.toWei(<span class="number">100</span> , <span class="string">&quot;ether&quot;</span>)&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>查询账户余额且以ether方式显示</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.fromWei(eth.getBalance(<span class="string">&quot;0xaC58C330aC8fF04fF828684d3FFABEFE987de7cb&quot;</span>)，,<span class="string">&#x27;ether&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>查询账户列表 </li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eth.accounts  #数组</span><br><span class="line">	- 输出结果：[]</span><br><span class="line">	- 含义：意思是无账户地址，因为我们什么也没做，所以当然是不会凭空出现账户了。</span><br></pre></td></tr></table></figure>

<ul>
<li>创建新账户         </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">personal.newAccount(<span class="string">&quot;password&quot;</span>)</span><br><span class="line"># 输出结果：hash</span><br><span class="line"># 含义：表明账户新建成功，返回账户地址，123为账户密码。此时我们再次查询账户列表会发现已有刚创建的地址了。</span><br></pre></td></tr></table></figure>

<ul>
<li>查询账户余额            </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eth.getBalance(eth.accounts[<span class="number">0</span>])</span><br><span class="line"># 输出结果：0</span><br><span class="line"># 含义：表明这个账户的余额是0。</span><br></pre></td></tr></table></figure>

<ul>
<li>启动或停止挖矿        </li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">miner.start();#开始挖矿</span><br><span class="line">admin.sleepBlocks(<span class="number">1</span>);</span><br><span class="line">miner.stop()</span><br></pre></td></tr></table></figure>

<ul>
<li>以Ether显示余额</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.fromWei(eth.getBalance(eth.accounts[0]),&quot;ether&quot;)#查询余额</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li>常见对象</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Geth Console 是一个交互式的 JavaScript 执行环境，里面内置了一些用来操作以太坊的 JavaScript 对象，我们可以直接调用这些对象来获取区块链上的相关信息。这些对象主要包括：</span><br><span class="line">		eth#主要包含对区块链进行访问和交互相关的方法；</span><br><span class="line">		net#主要包含查看 p2p 网络状态的方法；</span><br><span class="line">		admin#主要包含与管理节点相关的方法；</span><br><span class="line">		miner# 主要包含挖矿相关的一些方法；</span><br><span class="line">		personal#包含账户管理的方法；</span><br><span class="line">		txpool#包含查看交易内存池的方法；</span><br><span class="line">		web3#包含以上所有对象，还包含一些通用方法。</span><br></pre></td></tr></table></figure>
<ul>
<li>常用命令</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#分类展示常见命令：</span><br><span class="line">Personal:</span><br><span class="line">		personal.newAccount(&quot;password&quot;)#创建账户；</span><br><span class="line">		personal.unlockAccount(eth.accounts[0])#解锁账户0；</span><br><span class="line">		personal.unlockAccount(eth.coinbase)#解锁当前挖矿的账户</span><br><span class="line">         personal.sendTransaction() #发送交易；参数：from  to value </span><br><span class="line">Eth:</span><br><span class="line">		eth.accounts #数组；列出系统中的账户；</span><br><span class="line">		eth.getBalance()#查看账户余额，返回值的单位是 Wei；</span><br><span class="line">		eth.blockNumber#列出当前区块高度；</span><br><span class="line">		eth.getTransaction()#获取交易信息；</span><br><span class="line">		eth.getBlock()#获取区块信息；</span><br><span class="line">         eth.estimateGas(&#123;data: code&#125;)#估计部署合约要用的gas</span><br><span class="line">         eth.sendTransaction(&#123;from:eth.accounts[0],to:eth.accounts[1],value:web3.toWei(2)&#125;)#交易</span><br><span class="line">         <span class="comment">//部署合约</span></span><br><span class="line">         <span class="keyword">var</span> code =<span class="string">&quot;合约bytecode&quot;</span>;</span><br><span class="line">		<span class="keyword">var</span> abi = <span class="string">&quot;合约ABI&quot;</span>;</span><br><span class="line">         var myContract = eth.contract(abi) #创建类，合约的ABI</span><br><span class="line">         myContract.new(&#123;from:eth.accounts[0] , data:code , gas:210000&#125;)#创建合约实例</span><br><span class="line">Miner: </span><br><span class="line">		miner.start()#开始挖矿；默认线程12</span><br><span class="line">		miner.stop()#停止挖矿；</span><br><span class="line">         miner.setEtherbase(eth.accounts[0])#设置挖矿人</span><br><span class="line">Web3:</span><br><span class="line">		web3.fromWei()# Wei 换算成以太币；</span><br><span class="line">         web3.fromWei(eth.getBalance(eth.accounts[0]),&#x27;ether&#x27;)#以ether方式查看余额</span><br><span class="line">		web3.toWei()#以太币换算成 Wei；</span><br><span class="line">Txpool:</span><br><span class="line">		txpool.status#交易池中的状态； </span><br></pre></td></tr></table></figure>

<ul>
<li>既然是javaScript的执行环境，肯定可以定义一些变量等其他</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#定义变量</span><br><span class="line"><span class="keyword">var</span>  variablename = value;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Part2-部署智能合约"><a href="#Part2-部署智能合约" class="headerlink" title="Part2 部署智能合约"></a>Part2 部署智能合约</h3><ul>
<li>在Remix-IDE中，可可以在编译界面看到<ul>
<li>Compilation Details<ul>
<li>打开可以看到ABI（Json还要进行压缩转移麻烦）和ByteCode（也可以直接支付下方的）</li>
<li>更重要的是，可以直接复制WEB3DEPLOY的给定的JavaScript脚本直接粘贴到Geth即可，方便快捷</li>
<li><code>惭愧：上面两种方式我都失败了，懒得弄了，后续有需求在搞，网上教程找个很多，都是这样操作的，但是我就是不成功</code>，最后乖乖的直接部署到Ganache/TestRPC。</li>
</ul>
</li>
<li>IPFS，星际文件系统（分布式文件系统，去中心化，底层区块链）内容很多，功能很强大.<a target="_blank" rel="noopener" href="https://ipfs.io/">Download</a>科学上网去下，或者Git<ul>
<li>我目前知道的好处：比如，互联网中常见的html网页，很多都是重复的内容，但是存储多份；此时如果通过IPFS进行存储，由于IPFS是基于内容寻址的，所以只要内容一样，解析的地址是同一个</li>
<li>其次就是，IPDS也可以解决记录多版本问题</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/2020/11/29/Geth_note/1606645161742.png" alt="4"></p>
<ul>
<li>定义变量存储合约信息</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> code =<span class="string">&quot;合约bytecode&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> abi = <span class="string">&quot;合约ABI&quot;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>估算部署合约要用的gas</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eth.estimateGas(&#123;<span class="attr">data</span>: code&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>部署合约</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myContract = eth.contract(abi)</span><br><span class="line"><span class="comment">//创建类</span></span><br><span class="line"><span class="keyword">var</span> contract1 =myContract.new(&#123;<span class="attr">from</span>:<span class="string">&quot;0xe473d288faf6c2d1812dbb759d7423605c7d1a58&quot;</span>,<span class="attr">data</span>:code,<span class="attr">gas</span>:<span class="number">1200000</span>&#125;)</span><br><span class="line"><span class="comment">//创建合约实例。括号内部的from后填写的是你账户的地址。gas后填写你愿意支付的gas。原则上大于刚刚估计的值。</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看合约信息</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">contract1 </span><br><span class="line">txpool.status</span><br><span class="line"><span class="comment">//这个命令可以看到有没有待挖矿的交易。我们可以看到有一个。</span></span><br><span class="line">miner.start()</span><br><span class="line">miner.stop()</span><br><span class="line"><span class="comment">//挖一会矿再停下来。</span></span><br><span class="line">txpool.status</span><br><span class="line"><span class="comment">//待挖矿交易变为0。就说明合约已经写入链上了。</span></span><br><span class="line">contract1.address</span><br><span class="line"><span class="comment">//调用这个可以看到我们部署到链上的合约的地址了。这个值保存下来。以后要用到。</span></span><br></pre></td></tr></table></figure>
<ul>
<li>至此合约已经部署到了我们搭建的私链上了。</li>
</ul>
<hr>
<ul>
<li>如何调用已经部署好的合约</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 重新启动Geth控制台或者使用其他包时，调用原来部署好的智能合约要通过合约地址。</span><br><span class="line"># 没有写入链上的变量在经历重启geth或者重启web3程序时都会没有了。但是如果部署好的智能合约，并且写入数据时运用的交易都挖矿写入链中了。那么再次通过地址调用时关于合约的数据就都还保留。</span><br><span class="line"># 下面示例在Geth中调用合约的方法。假设我们现在已经重启了Geth控制台，首先还是要用合约地址实例化一个合约出来。</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> abi=<span class="built_in">JSON</span>.parse(‘合约的abi’)</span><br><span class="line"><span class="comment">//录入ABI。格式同上一节</span></span><br><span class="line">myContract = eth.contract(abi)</span><br><span class="line"><span class="comment">//创建类</span></span><br><span class="line">contract = myContract.at(address)</span><br><span class="line"><span class="comment">//创建合约实例，这里要指名部署过的合约地址。地址先前已经保存。</span></span><br></pre></td></tr></table></figure>
<p>通过geth控制台调用智能合约中的函数<br>智能合约中的函数分为两类，一种是需要付gas才能调用的函数，一种是无需花费gas的函数。这两类函数在geth控制台中被调用时用到的命令不一样，这里分别举两个例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">personal.unlockAccount(eth.coinbase)</span><br><span class="line"><span class="comment">//记得先解锁账户</span></span><br><span class="line">contract.函数名.sendTransaction(<span class="string">&quot;参数1&quot;</span>,<span class="string">&quot;参数2&quot;</span>,<span class="string">&quot;参数...&quot;</span>,&#123;<span class="attr">from</span>:<span class="string">&quot;0xe473d288faf6c2d1812dbb759d7423605c7d1a58&quot;</span>&#125;)</span><br><span class="line"><span class="comment">//上面是在geth控制台调用transactionn类型（要付gas类的）函数的方法。函数名要替换成自己的，括号内部前部分为函数的参数，分别列出，最后一项大括号内from要写付费的用户的地址（换成自己的）。</span></span><br><span class="line">contract.函数名.call(<span class="string">&quot;参数1&quot;</span>,<span class="string">&quot;参数2&quot;</span>, <span class="string">&quot;参数...&quot;</span>)</span><br><span class="line"><span class="comment">//调用call类型函数的方法，（不要付gas类的）。</span></span><br></pre></td></tr></table></figure>
<hr>
<p>所有函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&gt; eth.</span><br><span class="line">eth._requestManager            eth.getBlockTransactionCount   eth.getUncle</span><br><span class="line">eth.accounts                   eth.getBlockUncleCount         eth.getWork</span><br><span class="line">eth.blockNumber                eth.getCode                    eth.hashrate</span><br><span class="line">eth.call                       eth.getCoinbase                eth.iban</span><br><span class="line">eth.chainId                    eth.getCompilers               eth.icapNamereg</span><br><span class="line">eth.coinbase                   eth.getGasPrice                eth.isSyncing</span><br><span class="line">eth.compile                    eth.getHashrate                eth.mining</span><br><span class="line">eth.constructor                eth.getHeaderByHash            eth.namereg</span><br><span class="line">eth.contract                   eth.getHeaderByNumber          eth.pendingTransactions</span><br><span class="line">eth.defaultAccount             eth.getMining                  eth.protocolVersion</span><br><span class="line">eth.defaultBlock               eth.getPendingTransactions     eth.resend</span><br><span class="line">eth.estimateGas                eth.getProof                   eth.sendIBANTransaction</span><br><span class="line">eth.fillTransaction            eth.getProtocolVersion         eth.sendRawTransaction</span><br><span class="line">eth.filter                     eth.getRawTransaction          eth.sendTransaction</span><br><span class="line">eth.gasPrice                   eth.getRawTransactionFromBlock eth.sign</span><br><span class="line">eth.getAccounts                eth.getStorageAt               eth.signTransaction</span><br><span class="line">eth.getBalance                 eth.getSyncing                 eth.submitTransaction</span><br><span class="line">eth.getBlock                   eth.getTransaction             eth.submitWork</span><br><span class="line">eth.getBlockByHash             eth.getTransactionCount        eth.syncing</span><br><span class="line">eth.getBlockByNumber           eth.getTransactionFromBlock</span><br><span class="line">eth.getBlockNumber             eth.getTransactionReceipt</span><br><span class="line">&gt; personal.</span><br><span class="line">personal._requestManager  personal.getListWallets   personal.lockAccount      personal.signTransaction</span><br><span class="line">personal.constructor      personal.importRawKey     personal.newAccount       personal.unlockAccount</span><br><span class="line">personal.deriveAccount    personal.initializeWallet personal.openWallet       personal.unpair</span><br><span class="line">personal.ecRecover        personal.listAccounts     personal.sendTransaction</span><br><span class="line">personal.getListAccounts  personal.listWallets      personal.sign</span><br><span class="line">&gt; miner.</span><br><span class="line">miner.constructor          miner.propertyIsEnumerable miner.setRecommitInterval  miner.toString</span><br><span class="line">miner.getHashrate          miner.setEtherbase         miner.start                miner.valueOf</span><br><span class="line">miner.hasOwnProperty       miner.setExtra             miner.stop</span><br><span class="line">miner.isPrototypeOf        miner.setGasPrice          miner.toLocaleString</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Part3-本地环境信息"><a href="#Part3-本地环境信息" class="headerlink" title="Part3 本地环境信息"></a>Part3 本地环境信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line">&gt; admin</span><br><span class="line">		&#123;</span><br><span class="line">		  datadir: <span class="string">&quot;D:\\gethData&quot;</span>,</span><br><span class="line">		  nodeInfo: &#123;</span><br><span class="line">		    enode: <span class="string">&quot;enode://fac072814049255eb2f4c8c2c381183d87ee519d93600852cdcabd7dc3d9224d916be319bb2bfed89430112225f338d9dc15ea818f89cd242e46a05dd6bd63a7@192.168.136.117:30303&quot;</span>,</span><br><span class="line">		    enr: <span class="string">&quot;enr:-Je4QFYrz1dcrKYsGSKlFZARRs4T6pki558pyHzIb1294oLWfgVCCLANovQUjqPjxi7jqfHjS_Elg3BI97K7JyFtbVACg2V0aMfGhMmaRmeAgmlkgnY0gmlwhMCoiHWJc2VjcDI1NmsxoQP6wHKBQEklXrL0yMLDgRg9h-5RnZNgCFLNyr19w9kiTYN0Y3CCdl-DdWRwgnZf&quot;</span>,</span><br><span class="line">		    id: <span class="string">&quot;8a2d0a9309f63565292f84e6286532af5abc27df6abfb93f49c0d2d077b9666d&quot;</span>,</span><br><span class="line">		    ip: <span class="string">&quot;192.168.136.117&quot;</span>,</span><br><span class="line">		    listenAddr: <span class="string">&quot;[::]:30303&quot;</span>,</span><br><span class="line">		    name: <span class="string">&quot;Geth/v1.9.23-stable-8c2f2715/windows-amd64/go1.15&quot;</span>,</span><br><span class="line">		    ports: &#123;</span><br><span class="line">		      discovery: 30303,</span><br><span class="line">		      listener: 30303</span><br><span class="line">		    &#125;,</span><br><span class="line">		    protocols: &#123;</span><br><span class="line">		      eth: &#123;</span><br><span class="line">			config: &#123;...&#125;,</span><br><span class="line">			difficulty: 2000,</span><br><span class="line">			genesis: <span class="string">&quot;0xdc9866ac4601761e6b960e690eb144c03dd48e7125c99e14ecf0a0af5d739224&quot;</span>,</span><br><span class="line">			head: <span class="string">&quot;0xdc9866ac4601761e6b960e690eb144c03dd48e7125c99e14ecf0a0af5d739224&quot;</span>,</span><br><span class="line">			network: 16</span><br><span class="line">		      &#125;</span><br><span class="line">		    &#125;</span><br><span class="line">		  &#125;,</span><br><span class="line">		  peers: [&#123;</span><br><span class="line">		      caps: [<span class="string">&quot;eth/63&quot;</span>],</span><br><span class="line">		      enode: <span class="string">&quot;enode://8192f9e5cfa8fb73e914c39e830211ab2b98d6180df1cf009c1b1c9ddad3bb6d09d986db5ee125f4bb59c226014e72975f170c734774cc389ccb6e6f73fcce34@174.138.19.97:1234&quot;</span>,</span><br><span class="line">		      id: <span class="string">&quot;f227374bcd5f39fff43a333f04cbe43393f5db0baf5eb4ebddd9c8a9ae6fdfbe&quot;</span>,</span><br><span class="line">		      name: <span class="string">&quot;Geth/v1.0.0-stable-7e368c8e/linux-amd64/go1.12.10&quot;</span>,</span><br><span class="line">		      network: &#123;</span><br><span class="line">			inbound: <span class="literal">false</span>,</span><br><span class="line">			localAddress: <span class="string">&quot;192.168.1.118:50638&quot;</span>,</span><br><span class="line">			remoteAddress: <span class="string">&quot;174.138.19.97:1234&quot;</span>,</span><br><span class="line">			static: <span class="literal">false</span>,</span><br><span class="line">			trusted: <span class="literal">false</span></span><br><span class="line">		      &#125;,</span><br><span class="line">		      protocols: &#123;</span><br><span class="line">			eth: <span class="string">&quot;handshake&quot;</span></span><br><span class="line">		      &#125;</span><br><span class="line">		  &#125;, &#123;</span><br><span class="line">		      caps: [<span class="string">&quot;eth/63&quot;</span>, <span class="string">&quot;eth/64&quot;</span>, <span class="string">&quot;eth/65&quot;</span>],</span><br><span class="line">		      enode: <span class="string">&quot;enode://5928e6c7a1b9c90014b5b5ef5fbd305636b477f2e35b5c608ed7fae82e0ea3295be2c716ec50de640e5b0665c44f652cde5c9f3a6e4bcf134657a6944cd91d39@149.5.29.162:30303&quot;</span>,</span><br><span class="line">		      id: <span class="string">&quot;f24d4969e9e4f171b36d962f15ea1bc25b037731a99eee25887b02d1437d09ac&quot;</span>,</span><br><span class="line">		      name: <span class="string">&quot;Pirl/v1.9.12-v7-masternode-premium-lion-ea07aebf-20200407/linux-amd64/go1.13.6&quot;</span>,</span><br><span class="line">		      network: &#123;</span><br><span class="line">			inbound: <span class="literal">false</span>,</span><br><span class="line">			localAddress: <span class="string">&quot;192.168.1.118:50661&quot;</span>,</span><br><span class="line">			remoteAddress: <span class="string">&quot;149.5.29.162:30303&quot;</span>,</span><br><span class="line">			static: <span class="literal">false</span>,</span><br><span class="line">			trusted: <span class="literal">false</span></span><br><span class="line">		      &#125;,</span><br><span class="line">		      protocols: &#123;</span><br><span class="line">			eth: <span class="string">&quot;handshake&quot;</span></span><br><span class="line">		      &#125;</span><br><span class="line">		  &#125;],</span><br><span class="line">		  addPeer: <span class="keyword">function</span>(),</span><br><span class="line">		  addTrustedPeer: <span class="keyword">function</span>(),</span><br><span class="line">		  clearHistory: <span class="keyword">function</span>(),</span><br><span class="line">		  exportChain: <span class="keyword">function</span>(),</span><br><span class="line">		  getDatadir: <span class="keyword">function</span>(callback),</span><br><span class="line">		  getNodeInfo: <span class="keyword">function</span>(callback),</span><br><span class="line">		  getPeers: <span class="keyword">function</span>(callback),</span><br><span class="line">		  importChain: <span class="keyword">function</span>(),</span><br><span class="line">		  removePeer: <span class="keyword">function</span>(),</span><br><span class="line">		  removeTrustedPeer: <span class="keyword">function</span>(),</span><br><span class="line">		  sleep: <span class="keyword">function</span>(),</span><br><span class="line">		  sleepBlocks: <span class="keyword">function</span>(),</span><br><span class="line">		  startRPC: <span class="keyword">function</span>(),</span><br><span class="line">		  startWS: <span class="keyword">function</span>(),</span><br><span class="line">		  stopRPC: <span class="keyword">function</span>(),</span><br><span class="line">		  stopWS: <span class="keyword">function</span>()</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">personal</span><br><span class="line">		&gt; personal</span><br><span class="line">		&#123;</span><br><span class="line">		  listAccounts: [<span class="string">&quot;0xc59256c9f92d19e877d4a9931652ccbcd1260076&quot;</span>],</span><br><span class="line">		  listWallets: [&#123;</span><br><span class="line">		      accounts: [&#123;...&#125;],</span><br><span class="line">		      status: <span class="string">&quot;Locked&quot;</span>,</span><br><span class="line">		      url: <span class="string">&quot;keystore://D:\\gethData\\keystore\\UTC--2020-11-10T00-51-59.108912200Z--c59256c9f92d19e877d4a9931652ccbcd1260076&quot;</span></span><br><span class="line">		  &#125;],</span><br><span class="line">		  deriveAccount: <span class="keyword">function</span>(),</span><br><span class="line">		  ecRecover: <span class="keyword">function</span>(),</span><br><span class="line">		  getListAccounts: <span class="keyword">function</span>(callback),</span><br><span class="line">		  getListWallets: <span class="keyword">function</span>(callback),</span><br><span class="line">		  importRawKey: <span class="keyword">function</span>(),</span><br><span class="line">		  initializeWallet: <span class="keyword">function</span>(),</span><br><span class="line">		  lockAccount: <span class="keyword">function</span>(),</span><br><span class="line">		  newAccount: <span class="keyword">function</span>(),</span><br><span class="line">		  openWallet: <span class="keyword">function</span>(),</span><br><span class="line">		  sendTransaction: <span class="keyword">function</span>(),</span><br><span class="line">		  sign: <span class="keyword">function</span>(),</span><br><span class="line">		  signTransaction: <span class="keyword">function</span>(),</span><br><span class="line">		  unlockAccount: <span class="keyword">function</span>(),</span><br><span class="line">		  unpair: <span class="keyword">function</span>()</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">miner</span><br><span class="line">		&gt; miner</span><br><span class="line">		&#123;</span><br><span class="line">		  getHashrate: <span class="keyword">function</span>(),</span><br><span class="line">		  setEtherbase: <span class="keyword">function</span>(),</span><br><span class="line">		  setExtra: <span class="keyword">function</span>(),</span><br><span class="line">		  setGasPrice: <span class="keyword">function</span>(),</span><br><span class="line">		  setRecommitInterval: <span class="keyword">function</span>(),</span><br><span class="line">		  start: <span class="keyword">function</span>(),</span><br><span class="line">		  stop: <span class="keyword">function</span>()</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">eth</span><br><span class="line">		&gt; eth</span><br><span class="line">		&#123;</span><br><span class="line">		  accounts: [<span class="string">&quot;0xc59256c9f92d19e877d4a9931652ccbcd1260076&quot;</span>],</span><br><span class="line">		  blockNumber: 0,</span><br><span class="line">		  coinbase: <span class="string">&quot;0xc59256c9f92d19e877d4a9931652ccbcd1260076&quot;</span>,</span><br><span class="line">		  compile: &#123;</span><br><span class="line">		    lll: <span class="keyword">function</span>(),</span><br><span class="line">		    serpent: <span class="keyword">function</span>(),</span><br><span class="line">		    solidity: <span class="keyword">function</span>()</span><br><span class="line">		  &#125;,</span><br><span class="line">		  defaultAccount: undefined,</span><br><span class="line">		  defaultBlock: <span class="string">&quot;latest&quot;</span>,</span><br><span class="line">		  gasPrice: 1000000000,</span><br><span class="line">		  hashrate: 0,</span><br><span class="line">		  mining: <span class="literal">false</span>,</span><br><span class="line">		  pendingTransactions: [],</span><br><span class="line">		  protocolVersion: <span class="string">&quot;0x41&quot;</span>,</span><br><span class="line">		  syncing: <span class="literal">false</span>,</span><br><span class="line">		  call: <span class="keyword">function</span>(),</span><br><span class="line">		  chainId: <span class="keyword">function</span>(),</span><br><span class="line">		  contract: <span class="keyword">function</span>(abi),</span><br><span class="line">		  estimateGas: <span class="keyword">function</span>(),</span><br><span class="line">		  fillTransaction: <span class="keyword">function</span>(),</span><br><span class="line">		  filter: <span class="keyword">function</span>(options, callback, filterCreationErrorCallback),</span><br><span class="line">		  getAccounts: <span class="keyword">function</span>(callback),</span><br><span class="line">		  getBalance: <span class="keyword">function</span>(),</span><br><span class="line">		  getBlock: <span class="keyword">function</span>(),</span><br><span class="line">		  getBlockByHash: <span class="keyword">function</span>(),</span><br><span class="line">		  getBlockByNumber: <span class="keyword">function</span>(),</span><br><span class="line">		  getBlockNumber: <span class="keyword">function</span>(callback),</span><br><span class="line">		  getBlockTransactionCount: <span class="keyword">function</span>(),</span><br><span class="line">		  getBlockUncleCount: <span class="keyword">function</span>(),</span><br><span class="line">		  getCode: <span class="keyword">function</span>(),</span><br><span class="line">		  getCoinbase: <span class="keyword">function</span>(callback),</span><br><span class="line">		  getCompilers: <span class="keyword">function</span>(),</span><br><span class="line">		  getGasPrice: <span class="keyword">function</span>(callback),</span><br><span class="line">		  getHashrate: <span class="keyword">function</span>(callback),</span><br><span class="line">		  getHeaderByHash: <span class="keyword">function</span>(),</span><br><span class="line">		  getHeaderByNumber: <span class="keyword">function</span>(),</span><br><span class="line">		  getMining: <span class="keyword">function</span>(callback),</span><br><span class="line">		  getPendingTransactions: <span class="keyword">function</span>(callback),</span><br><span class="line">		  getProof: <span class="keyword">function</span>(),</span><br><span class="line">		  getProtocolVersion: <span class="keyword">function</span>(callback),</span><br><span class="line">		  getRawTransaction: <span class="keyword">function</span>(),</span><br><span class="line">		  getRawTransactionFromBlock: <span class="keyword">function</span>(),</span><br><span class="line">		  getStorageAt: <span class="keyword">function</span>(),</span><br><span class="line">		  getSyncing: <span class="keyword">function</span>(callback),</span><br><span class="line">		  getTransaction: <span class="keyword">function</span>(),</span><br><span class="line">		  getTransactionCount: <span class="keyword">function</span>(),</span><br><span class="line">		  getTransactionFromBlock: <span class="keyword">function</span>(),</span><br><span class="line">		  getTransactionReceipt: <span class="keyword">function</span>(),</span><br><span class="line">		  getUncle: <span class="keyword">function</span>(),</span><br><span class="line">		  getWork: <span class="keyword">function</span>(),</span><br><span class="line">		  iban: <span class="keyword">function</span>(iban),</span><br><span class="line">		  icapNamereg: <span class="keyword">function</span>(),</span><br><span class="line">		  isSyncing: <span class="keyword">function</span>(callback),</span><br><span class="line">		  namereg: <span class="keyword">function</span>(),</span><br><span class="line">		  resend: <span class="keyword">function</span>(),</span><br><span class="line">		  sendIBANTransaction: <span class="keyword">function</span>(),</span><br><span class="line">		  sendRawTransaction: <span class="keyword">function</span>(),</span><br><span class="line">		  sendTransaction: <span class="keyword">function</span>(),</span><br><span class="line">		  sign: <span class="keyword">function</span>(),</span><br><span class="line">		  signTransaction: <span class="keyword">function</span>(),</span><br><span class="line">		  submitTransaction: <span class="keyword">function</span>(),</span><br><span class="line">		  submitWork: <span class="keyword">function</span>()</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BlockChain/" rel="tag">BlockChain</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Geth/" rel="tag">Geth</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MetaMask/" rel="tag">MetaMask</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-EVM_Source"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/29/EVM_Source/"
    >以太坊源码分析 - 交易源码分析</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/29/EVM_Source/" class="article-date">
  <time datetime="2020-11-29T09:22:14.000Z" itemprop="datePublished">2020-11-29</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/BlockChain/">BlockChain</a> / <a class="article-category-link" href="/categories/BlockChain/EVM/">EVM</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p><strong>目录</strong></p>
<p><a href>一 . 发起交易</a></p>
<p><a href>1. 发送交易时参数的机构体对象</a></p>
<p><a href>2. SendTransaction（）方法介绍</a></p>
<p><a href>2.1. toTransaction（）方法</a></p>
<p><a href>2.2. 调用wallet.SignTx(account, tx, chainID)对当前交易进行签名。</a></p>
<p><a href>2.2.1 调用types.SignTx方法进行签名</a></p>
<p><a href>2.2.2 调用WithSignature为交易设置签名</a></p>
<p><a href>2.2.3 调用SignatureValues方法获取r,s,v字段</a></p>
<p><a href>2.3 调用submitTransaction提交交易</a></p>
<p><a href>二. 节点接收交易</a></p>
<p><a href>1. 执行add方法将交易添加到交易池中</a></p>
<p><a href>2. 调用validateTx验证交易</a></p>
<p><a href>3. 调用pool.enqueueTx(hash, tx)，将交易添加到待执行的交易队列中</a></p>
<p><a href>3.1 调用queue的add方法替换交易</a></p>
<p><a href>4. 调用promoteExecutables方法将交易插入到pending执行队列中</a></p>
<p><a href>4.1 调用promoteTx将交易广播到其他节点</a></p>
<p>以太坊的交易的生命周期主要包括以下几部分：</p>
<p>\1. 用户发送交易</p>
<p>\2. 节点接收交易</p>
<p>\3. 执行交易</p>
<p>\4. 打包区块</p>
<p>\5. 矿工节点挖矿</p>
<p>\6. 区块广播，交易保存到链上</p>
<p>在当前博文里面主要包含，用户如何发起交易、以及交易的签名、交易发送到交易池中、交易池广播交易等</p>
<h1 id="一-发起交易"><a href="#一-发起交易" class="headerlink" title="一 . 发起交易"></a>一 . 发起交易</h1><p>​       用户通过grpc接口调用go-ethereum\internal\ethapi 里面 PublicTransactionPoolAPI结构体里面的SendTransaction的方法发送交易，在该方法内部根据发送的地址获取当前用户的钱包信息，然后对生成交易对象，利用私钥对交易签名，最后提交交易。下面是对该方法的具体介绍</p>
<h2 id="1-发送交易时参数的机构体对象"><a href="#1-发送交易时参数的机构体对象" class="headerlink" title="1. 发送交易时参数的机构体对象"></a>1. 发送交易时参数的机构体对象</h2><p> 参数<br>           ctx：上下文信息<br>          args:发送交易时的参数包含值（from，To,Gas,Gasprice,Value,Nonce,Data,Input）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送交易信息的结构体</span></span><br><span class="line"><span class="keyword">type</span> SendTxArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">	From     common.Address  <span class="string">`json:&quot;from&quot;`</span>     <span class="comment">//发送人</span></span><br><span class="line">	To       *common.Address <span class="string">`json:&quot;to&quot;`</span>       <span class="comment">//接收地址</span></span><br><span class="line">	Gas      *hexutil.Uint64 <span class="string">`json:&quot;gas&quot;`</span>      <span class="comment">//gas</span></span><br><span class="line">	GasPrice *hexutil.Big    <span class="string">`json:&quot;gasPrice&quot;`</span> <span class="comment">//gasprice</span></span><br><span class="line">	Value    *hexutil.Big    <span class="string">`json:&quot;value&quot;`</span>    <span class="comment">//交易的值</span></span><br><span class="line">	Nonce    *hexutil.Uint64 <span class="string">`json:&quot;nonce&quot;`</span>    <span class="comment">//交易的nonce</span></span><br><span class="line">	<span class="comment">// We accept &quot;data&quot; and &quot;input&quot; for backwards-compatibility reasons. &quot;input&quot; is the</span></span><br><span class="line">	<span class="comment">// newer name and should be preferred by clients.</span></span><br><span class="line">	Data  *hexutil.Bytes <span class="string">`json:&quot;data&quot;`</span></span><br><span class="line">	Input *hexutil.Bytes <span class="string">`json:&quot;input&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-SendTransaction（）方法介绍"><a href="#2-SendTransaction（）方法介绍" class="headerlink" title="2. SendTransaction（）方法介绍"></a>2. SendTransaction（）方法介绍</h2><p>执行步骤<br>          2.1 根据from参数获取账号<br>          2.2 调用args.toTranscation方法生产交易tx对象<br>          2.3 调用wallet.SignTx方法对当前交易进行签名<br>          2.4 调用submitTransaction(ctx,s.b,signed)函数提交当前的交易</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PublicTransactionPoolAPI)</span> <span class="title">SendTransaction</span><span class="params">(ctx context.Context, args SendTxArgs)</span> <span class="params">(common.Hash, error)</span></span> &#123;</span><br><span class="line">	account := accounts.Account&#123;Address: args.From&#125;</span><br><span class="line">	wallet, err := s.b.AccountManager().Find(account)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> common.Hash&#123;&#125;, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> args.Nonce == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// Hold the addresse&#x27;s mutex around signing to prevent concurrent assignment of</span></span><br><span class="line">		<span class="comment">// the same nonce to multiple accounts.</span></span><br><span class="line">		s.nonceLock.LockAddr(args.From)</span><br><span class="line">		<span class="keyword">defer</span> s.nonceLock.UnlockAddr(args.From)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := args.setDefaults(ctx, s.b); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> common.Hash&#123;&#125;, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将当前的交易信息生成交易信息</span></span><br><span class="line">	tx := args.toTransaction()</span><br><span class="line">	<span class="keyword">var</span> chainID *big.Int <span class="comment">//获取当前区块链的ID</span></span><br><span class="line">	<span class="keyword">if</span> config := s.b.ChainConfig(); config.IsEIP155(s.b.CurrentBlock().Number()) &#123;</span><br><span class="line">		chainID = config.ChainID</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//对当前的交易进行签名</span></span><br><span class="line">	signed, err := wallet.SignTx(account, tx, chainID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> common.Hash&#123;&#125;, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> submitTransaction(ctx, s.b, signed)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-toTransaction（）方法"><a href="#2-1-toTransaction（）方法" class="headerlink" title="2.1. toTransaction（）方法"></a>2.1. toTransaction（）方法</h3><p>交易的结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">以太坊交易的结构体</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">type</span> Transaction <span class="keyword">struct</span> &#123;</span><br><span class="line">	data txdata <span class="comment">//交易的数据</span></span><br><span class="line">	<span class="comment">// caches</span></span><br><span class="line">	hash atomic.Value</span><br><span class="line">	size atomic.Value</span><br><span class="line">	from atomic.Value</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> txdata <span class="keyword">struct</span> &#123;</span><br><span class="line">	AccountNonce <span class="keyword">uint64</span>          <span class="string">`json:&quot;nonce&quot;    gencodec:&quot;required&quot;`</span> <span class="comment">//发送者发送交易数的计数</span></span><br><span class="line">	Price        *big.Int        <span class="string">`json:&quot;gasPrice&quot; gencodec:&quot;required&quot;`</span> <span class="comment">//发送者愿意支付执行交易所需的每个gas的Wei数量</span></span><br><span class="line">	GasLimit     <span class="keyword">uint64</span>          <span class="string">`json:&quot;gas&quot;      gencodec:&quot;required&quot;`</span> <span class="comment">//发送者愿意为执行交易支付gas数量的最大值。这个数量被设置之后在任何计算完成之前就会被提前扣掉</span></span><br><span class="line">	Recipient    *common.Address <span class="string">`json:&quot;to&quot;       rlp:&quot;nil&quot;`</span>           <span class="comment">// nil means contract creation 所使用的接收人的地址，如果为空的话，这说明是使用合约地址</span></span><br><span class="line">	Amount       *big.Int        <span class="string">`json:&quot;value&quot;    gencodec:&quot;required&quot;`</span> <span class="comment">// 从发送者转移到接收者的Wei数量。在合约创建交易中，value作为新建合约账户的开始余额</span></span><br><span class="line">	Payload      []<span class="keyword">byte</span>          <span class="string">`json:&quot;input&quot;    gencodec:&quot;required&quot;`</span> <span class="comment">//在调用合约函数时input中保存的是合约函数的名称及参数，在部署合约时input中保持的是合约的abi,data及合约构造函数的参数</span></span><br><span class="line">	<span class="comment">// Signature values</span></span><br><span class="line">	V *big.Int <span class="string">`json:&quot;v&quot; gencodec:&quot;required&quot;`</span> <span class="comment">//用于标识交易时产生的签名</span></span><br><span class="line">	R *big.Int <span class="string">`json:&quot;r&quot; gencodec:&quot;required&quot;`</span> <span class="comment">//用于标识交易时产生的签名</span></span><br><span class="line">	S *big.Int <span class="string">`json:&quot;s&quot; gencodec:&quot;required&quot;`</span> <span class="comment">//用于标识交易时产生的签名</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// This is only used when marshaling to JSON.</span></span><br><span class="line">	Hash *common.Hash <span class="string">`json:&quot;hash&quot; rlp:&quot;-&quot;`</span> <span class="comment">//当前交易的hash</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>根据输入的参数生成Transaction对象，根据输入参数里面的to字段判端，如果to字段为空的话，则为合约交易，否则为正常交易</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">利用发送的信息生成新的交易</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(args *SendTxArgs)</span> <span class="title">toTransaction</span><span class="params">()</span> *<span class="title">types</span>.<span class="title">Transaction</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> input []<span class="keyword">byte</span></span><br><span class="line">	<span class="keyword">if</span> args.Data != <span class="literal">nil</span> &#123;</span><br><span class="line">		input = *args.Data</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> args.Input != <span class="literal">nil</span> &#123;</span><br><span class="line">		input = *args.Input</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> args.To == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> types.NewContractCreation(<span class="keyword">uint64</span>(*args.Nonce), (*big.Int)(args.Value), <span class="keyword">uint64</span>(*args.Gas), (*big.Int)(args.GasPrice), input)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> types.NewTransaction(<span class="keyword">uint64</span>(*args.Nonce), *args.To, (*big.Int)(args.Value), <span class="keyword">uint64</span>(*args.Gas), (*big.Int)(args.GasPrice), input)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-调用wallet-SignTx-account-tx-chainID-对当前交易进行签名。"><a href="#2-2-调用wallet-SignTx-account-tx-chainID-对当前交易进行签名。" class="headerlink" title="2.2. 调用wallet.SignTx(account, tx, chainID)对当前交易进行签名。"></a>2.2. 调用wallet.SignTx(account, tx, chainID)对当前交易进行签名。</h3><p>​     对交易签名分为利用硬件钱包签名和keystore签名，在本地我们讲的是利用keystore进行签名。代码路径：go-ethereum\accounts\keystore\keystore.go</p>
<p>主要步骤有：</p>
<ul>
<li>根据钱包地址，查看当前钱包是否已解锁</li>
<li>如果已解锁的话，调用types.SignTx对交易进行签名</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ks *KeyStore)</span> <span class="title">SignTx</span><span class="params">(a accounts.Account, tx *types.Transaction, chainID *big.Int)</span> <span class="params">(*types.Transaction, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Look up the key to sign with and abort if it cannot be found</span></span><br><span class="line">	ks.mu.RLock()</span><br><span class="line">	<span class="keyword">defer</span> ks.mu.RUnlock()</span><br><span class="line">	unlockedKey, found := ks.unlocked[a.Address]</span><br><span class="line">	<span class="keyword">if</span> !found &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrLocked</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Depending on the presence of the chain ID, sign with EIP155 or homestead</span></span><br><span class="line">	<span class="keyword">if</span> chainID != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> types.SignTx(tx, types.NewEIP155Signer(chainID), unlockedKey.PrivateKey)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> types.SignTx(tx, types.HomesteadSigner&#123;&#125;, unlockedKey.PrivateKey)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-1-调用types-SignTx方法进行签名"><a href="#2-2-1-调用types-SignTx方法进行签名" class="headerlink" title="2.2.1 调用types.SignTx方法进行签名"></a>2.2.1 调用types.SignTx方法进行签名</h3><p>主要操作：</p>
<ul>
<li>​     将当前交易进行hash</li>
<li>​     利用私钥对交易的hash值进行签名</li>
<li>​     调用tx.WithSignature(s, sig)方法，将交易的签名分别写到交易结构体里面 v,r,s字段</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SignTx</span><span class="params">(tx *Transaction, s Signer, prv *ecdsa.PrivateKey)</span> <span class="params">(*Transaction, error)</span></span> &#123;</span><br><span class="line">	h := s.Hash(tx)</span><br><span class="line">	sig, err := crypto.Sign(h[:], prv)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> tx.WithSignature(s, sig)</span><br></pre></td></tr></table></figure>

<h3 id="2-2-2-调用WithSignature为交易设置签名"><a href="#2-2-2-调用WithSignature为交易设置签名" class="headerlink" title="2.2.2 调用WithSignature为交易设置签名"></a>2.2.2 调用WithSignature为交易设置签名</h3><p>主要步骤：</p>
<ul>
<li>调用签名笔的SignatureValues对象分别获取r,s,v字段</li>
<li>将r,s,v字段设置到transation中，并返回交易</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tx *Transaction)</span> <span class="title">WithSignature</span><span class="params">(signer Signer, sig []<span class="keyword">byte</span>)</span> <span class="params">(*Transaction, error)</span></span> &#123;</span><br><span class="line">	r, s, v, err := signer.SignatureValues(tx, sig)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	cpy := &amp;Transaction&#123;data: tx.data&#125;</span><br><span class="line">	cpy.data.R, cpy.data.S, cpy.data.V = r, s, v</span><br><span class="line">	<span class="keyword">return</span> cpy, <span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-3-调用SignatureValues方法获取r-s-v字段"><a href="#2-2-3-调用SignatureValues方法获取r-s-v字段" class="headerlink" title="2.2.3 调用SignatureValues方法获取r,s,v字段"></a>2.2.3 调用SignatureValues方法获取r,s,v字段</h3><p>主要操作：</p>
<ul>
<li> 获取交易签名的前32位赋值给r</li>
<li>获取交易签名的32-64位赋值给s</li>
<li>获取交易签名的最后一位赋值为v</li>
<li>返回r,s,v</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fs FrontierSigner)</span> <span class="title">SignatureValues</span><span class="params">(tx *Transaction, sig []<span class="keyword">byte</span>)</span> <span class="params">(r, s, v *big.Int, err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(sig) != <span class="number">65</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;wrong size for signature: got %d, want 65&quot;</span>, <span class="built_in">len</span>(sig)))</span><br><span class="line">	&#125;</span><br><span class="line">	r = <span class="built_in">new</span>(big.Int).SetBytes(sig[:<span class="number">32</span>])</span><br><span class="line">	s = <span class="built_in">new</span>(big.Int).SetBytes(sig[<span class="number">32</span>:<span class="number">64</span>])</span><br><span class="line">	v = <span class="built_in">new</span>(big.Int).SetBytes([]<span class="keyword">byte</span>&#123;sig[<span class="number">64</span>] + <span class="number">27</span>&#125;)</span><br><span class="line">	<span class="keyword">return</span> r, s, v, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-调用submitTransaction提交交易"><a href="#2-3-调用submitTransaction提交交易" class="headerlink" title="2.3 调用submitTransaction提交交易"></a>2.3 调用submitTransaction提交交易</h2><p>主要步骤：</p>
<ul>
<li>调用grpc SendTx发送交易到节点</li>
<li>如果交易的to字段为空的话，根据发送者的地址和交易的nonce值，生成合约地址</li>
<li>返回交易的hash值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">提交当前的交易</span></span><br><span class="line"><span class="comment">parama:执行交易的上下文，交易的接口，交易</span></span><br><span class="line"><span class="comment">return 交易的hash</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">submitTransaction</span><span class="params">(ctx context.Context, b Backend, tx *types.Transaction)</span> <span class="params">(common.Hash, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := b.SendTx(ctx, tx); err != <span class="literal">nil</span> &#123; <span class="comment">//发送交易</span></span><br><span class="line">		<span class="keyword">return</span> common.Hash&#123;&#125;, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> tx.To() == <span class="literal">nil</span> &#123; <span class="comment">//如果TO==nil，则为合约账户</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		signer := types.MakeSigner(b.ChainConfig(), b.CurrentBlock().Number())</span><br><span class="line">		from, err := types.Sender(signer, tx)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> common.Hash&#123;&#125;, err</span><br><span class="line">		&#125;</span><br><span class="line">		addr := crypto.CreateAddress(from, tx.Nonce()) <span class="comment">//创建合约账号地址</span></span><br><span class="line">		log.Info(<span class="string">&quot;Submitted contract creation&quot;</span>, <span class="string">&quot;fullhash&quot;</span>, tx.Hash().Hex(), <span class="string">&quot;contract&quot;</span>, addr.Hex())</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		log.Info(<span class="string">&quot;Submitted transaction&quot;</span>, <span class="string">&quot;fullhash&quot;</span>, tx.Hash().Hex(), <span class="string">&quot;recipient&quot;</span>, tx.To())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> tx.Hash(), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二-节点接收交易"><a href="#二-节点接收交易" class="headerlink" title="二. 节点接收交易"></a>二. 节点接收交易</h1><p>以太坊的将新的交易添加到交易池时分两种情况：</p>
<ul>
<li>本地交易：如果是本地交易的话，当添加到交易池之后，交易的发送地址存会被放在locals列表里面，这个账户的关联的交易将不会因为价格的限制或者其他的一些限制被删除</li>
<li>远程交易：远程发送来的交易为普通交易，交易可能会因为价格或者gas的限制等原因被从交易池里面的剔除</li>
</ul>
<h2 id="1-执行add方法将交易添加到交易池中"><a href="#1-执行add方法将交易添加到交易池中" class="headerlink" title="1. 执行add方法将交易添加到交易池中"></a>1. 执行add方法将交易添加到交易池中</h2><p>主要步骤：</p>
<ul>
<li>检查当前交易是否在交易池里面已存在</li>
<li>调用validateTx方法验证当前交易，如果验证没有通过的话直接丢弃</li>
<li>查看当前交易池是否已满（5120），如果已经满了的话在交易池里面删除价格比较低的交易，如果当前交易的价格比较低的话直接拒绝接收</li>
<li>查看当前交易是否已经在正在处理的交易列表里面，如果在看能否替换旧的交易，并将新的交易添加到交易池中，同时将当前交易广播给其他节点</li>
<li>如果当前交易不能替换正在处理的交易列表（peeding）,则将交易放在待处理的交易列表中（queue)</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pool *TxPool)</span> <span class="title">add</span><span class="params">(tx *types.Transaction, local <span class="keyword">bool</span>)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// If the transaction is already known, discard it</span></span><br><span class="line">	hash := tx.Hash()</span><br><span class="line">	<span class="keyword">if</span> pool.all[hash] != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Trace(<span class="string">&quot;Discarding already known transaction&quot;</span>, <span class="string">&quot;hash&quot;</span>, hash)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;known transaction: %x&quot;</span>, hash)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If the transaction fails basic validation, discard it</span></span><br><span class="line">	<span class="comment">// 如果交易不能通过基本的验证,那么丢弃它</span></span><br><span class="line">	<span class="keyword">if</span> err := pool.validateTx(tx, local); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Trace(<span class="string">&quot;Discarding invalid transaction&quot;</span>, <span class="string">&quot;hash&quot;</span>, hash, <span class="string">&quot;err&quot;</span>, err)</span><br><span class="line">		invalidTxCounter.Inc(<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If the transaction pool is full, discard underpriced transactions</span></span><br><span class="line">	<span class="comment">// 如果交易池满了. 那么删除一些低价的交易.</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">uint64</span>(<span class="built_in">len</span>(pool.all)) &gt;= pool.config.GlobalSlots+pool.config.GlobalQueue &#123;</span><br><span class="line">		<span class="comment">// If the new transaction is underpriced, don&#x27;t accept it</span></span><br><span class="line">		<span class="comment">// 如果新交易本身就是低价的，不接收</span></span><br><span class="line">		<span class="keyword">if</span> !local &amp;&amp; pool.priced.Underpriced(tx, pool.locals) &#123;</span><br><span class="line">			log.Trace(<span class="string">&quot;Discarding underpriced transaction&quot;</span>, <span class="string">&quot;hash&quot;</span>, hash, <span class="string">&quot;price&quot;</span>, tx.GasPrice())</span><br><span class="line">			underpricedTxCounter.Inc(<span class="number">1</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>, ErrUnderpriced</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// New transaction is better than our worse ones, make room for it</span></span><br><span class="line">		<span class="comment">// 否则删除低价的池给他腾空间</span></span><br><span class="line">		drop := pool.priced.Discard(<span class="built_in">len</span>(pool.all)-<span class="keyword">int</span>(pool.config.GlobalSlots+pool.config.GlobalQueue<span class="number">-1</span>), pool.locals)</span><br><span class="line">		<span class="keyword">for</span> _, tx := <span class="keyword">range</span> drop &#123;</span><br><span class="line">			log.Trace(<span class="string">&quot;Discarding freshly underpriced transaction&quot;</span>, <span class="string">&quot;hash&quot;</span>, tx.Hash(), <span class="string">&quot;price&quot;</span>, tx.GasPrice())</span><br><span class="line">			underpricedTxCounter.Inc(<span class="number">1</span>)</span><br><span class="line">			pool.removeTx(tx.Hash(), <span class="literal">false</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If the transaction is replacing an already pending one, do directly</span></span><br><span class="line">	<span class="comment">//验证交易签名</span></span><br><span class="line">	from, _ := types.Sender(pool.signer, tx) <span class="comment">// already validated</span></span><br><span class="line">	<span class="keyword">if</span> list := pool.pending[from]; list != <span class="literal">nil</span> &amp;&amp; list.Overlaps(tx) &#123;</span><br><span class="line">		<span class="comment">// Nonce already pending, check if required price bump is met</span></span><br><span class="line">		<span class="comment">// 如果交易对应的Nonce已经在pending队列了,那么看是否能够替换.</span></span><br><span class="line">		inserted, old := list.Add(tx, pool.config.PriceBump)</span><br><span class="line">		<span class="keyword">if</span> !inserted &#123;</span><br><span class="line">			pendingDiscardCounter.Inc(<span class="number">1</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>, ErrReplaceUnderpriced</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// New transaction is better, replace old one</span></span><br><span class="line">		<span class="keyword">if</span> old != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">delete</span>(pool.all, old.Hash())</span><br><span class="line">			pool.priced.Removed()</span><br><span class="line">			pendingReplaceCounter.Inc(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		pool.all[tx.Hash()] = tx</span><br><span class="line">		pool.priced.Put(tx)</span><br><span class="line">		pool.journalTx(from, tx)</span><br><span class="line"> </span><br><span class="line">		log.Trace(<span class="string">&quot;Pooled new executable transaction&quot;</span>, <span class="string">&quot;hash&quot;</span>, hash, <span class="string">&quot;from&quot;</span>, from, <span class="string">&quot;to&quot;</span>, tx.To())</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// We&#x27;ve directly injected a replacement transaction, notify subsystems</span></span><br><span class="line">		<span class="comment">//直接注入了一个替换事务，通知子系统</span></span><br><span class="line">		<span class="keyword">go</span> pool.txFeed.Send(TxPreEvent&#123;tx&#125;)</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">return</span> old != <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// New transaction isn&#x27;t replacing a pending one, push into queue</span></span><br><span class="line">	<span class="comment">// 新交易不能替换pending里面的任意一个交易,那么把他push到futuren 队列里面.</span></span><br><span class="line">	replace, err := pool.enqueueTx(hash, tx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Mark local addresses and journal local transactions</span></span><br><span class="line">	<span class="keyword">if</span> local &#123;</span><br><span class="line">		pool.locals.add(from)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 如果是本地的交易,会被记录进入journalTx</span></span><br><span class="line">	pool.journalTx(from, tx) <span class="comment">//存到硬盘</span></span><br><span class="line"> </span><br><span class="line">	log.Trace(<span class="string">&quot;Pooled new future transaction&quot;</span>, <span class="string">&quot;hash&quot;</span>, hash, <span class="string">&quot;from&quot;</span>, from, <span class="string">&quot;to&quot;</span>, tx.To())</span><br><span class="line">	<span class="keyword">return</span> replace, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-调用validateTx验证交易"><a href="#2-调用validateTx验证交易" class="headerlink" title="2. 调用validateTx验证交易"></a>2. 调用validateTx验证交易</h2><p>主要步骤如下：</p>
<ul>
<li>检查交易的大小</li>
<li>检查交易签名</li>
<li>验证当前交易的gasprice是否小于交易池设置的gasPrice(本地交易不做此验证)</li>
<li>验证交易的Nonce</li>
<li>验证用户当前的余额是否足够</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// validateTx 使用一致性规则来检查一个交易是否有效,并采用本地节点的一些启发式的限制.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pool *TxPool)</span> <span class="title">validateTx</span><span class="params">(tx *types.Transaction, local <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// Heuristic limit, reject transactions over 32KB to prevent DOS attacks</span></span><br><span class="line">	<span class="keyword">if</span> tx.Size() &gt; <span class="number">32</span>*<span class="number">1024</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ErrOversizedData</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Transactions can&#x27;t be negative. This may never happen using RLP decoded</span></span><br><span class="line">	<span class="comment">// transactions but may occur if you create a transaction using the RPC.</span></span><br><span class="line">	<span class="keyword">if</span> tx.Value().Sign() &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ErrNegativeValue</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Ensure the transaction doesn&#x27;t exceed the current block limit gas.</span></span><br><span class="line">	<span class="keyword">if</span> pool.currentMaxGas &lt; tx.Gas() &#123;</span><br><span class="line">		<span class="keyword">return</span> ErrGasLimit</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Make sure the transaction is signed properly</span></span><br><span class="line">	<span class="comment">// 确保交易被正确签名.</span></span><br><span class="line">	from, err := types.Sender(pool.signer, tx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ErrInvalidSender</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Drop non-local transactions under our own minimal accepted gas price</span></span><br><span class="line">	<span class="comment">// 如果不是本地的交易,并且GasPrice低于我们的设置,那么也不会接收.</span></span><br><span class="line">	local = local || pool.locals.contains(from) <span class="comment">// account may be local even if the transaction arrived from the network</span></span><br><span class="line">	<span class="keyword">if</span> !local &amp;&amp; pool.gasPrice.Cmp(tx.GasPrice()) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ErrUnderpriced</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Ensure the transaction adheres to nonce ordering</span></span><br><span class="line">	<span class="comment">// 确保交易遵守了Nonce的顺序,账户的nonce</span></span><br><span class="line">	<span class="keyword">if</span> pool.currentState.GetNonce(from) &gt; tx.Nonce() &#123;</span><br><span class="line">		<span class="keyword">return</span> ErrNonceTooLow</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Transactor should have enough funds to cover the costs</span></span><br><span class="line">	<span class="comment">// cost == V + GP * GL</span></span><br><span class="line">	<span class="comment">// 确保用户有足够的余额来支付.</span></span><br><span class="line">	<span class="keyword">if</span> pool.currentState.GetBalance(from).Cmp(tx.Cost()) &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ErrInsufficientFunds</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	intrGas, err := IntrinsicGas(tx.Data(), tx.To() == <span class="literal">nil</span>, pool.homestead)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 如果交易是一个合约创建或者调用. 那么看看是否有足够的 初始Gas.</span></span><br><span class="line">	<span class="keyword">if</span> tx.Gas() &lt; intrGas &#123;</span><br><span class="line">		<span class="keyword">return</span> ErrIntrinsicGas</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-调用pool-enqueueTx-hash-tx-，将交易添加到待执行的交易队列中"><a href="#3-调用pool-enqueueTx-hash-tx-，将交易添加到待执行的交易队列中" class="headerlink" title="3. 调用pool.enqueueTx(hash, tx)，将交易添加到待执行的交易队列中"></a>3. 调用pool.enqueueTx(hash, tx)，将交易添加到待执行的交易队列中</h2><p>主要操作：</p>
<ul>
<li>验证交易签名</li>
<li>调用queue的add方法替换该账户中比较老的未执行的交易</li>
<li>将当前交易添加到所有交易池中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将一个新的交易插入到future queue</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pool *TxPool)</span> <span class="title">enqueueTx</span><span class="params">(hash common.Hash, tx *types.Transaction)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Try to insert the transaction into the future queue</span></span><br><span class="line">	from, _ := types.Sender(pool.signer, tx) <span class="comment">// already validated 验证签名</span></span><br><span class="line">	<span class="keyword">if</span> pool.queue[from] == <span class="literal">nil</span> &#123;</span><br><span class="line">		pool.queue[from] = newTxList(<span class="literal">false</span>) <span class="comment">//如果pool.queue不存在当前地址</span></span><br><span class="line">	&#125;</span><br><span class="line">	inserted, old := pool.queue[from].Add(tx, pool.config.PriceBump)</span><br><span class="line">	<span class="keyword">if</span> !inserted &#123;</span><br><span class="line">		<span class="comment">// An older transaction was better, discard this</span></span><br><span class="line">		queuedDiscardCounter.Inc(<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, ErrReplaceUnderpriced</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Discard any previous transaction and mark this</span></span><br><span class="line">	<span class="keyword">if</span> old != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">delete</span>(pool.all, old.Hash())</span><br><span class="line">		pool.priced.Removed()</span><br><span class="line">		queuedReplaceCounter.Inc(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> pool.all[hash] == <span class="literal">nil</span> &#123;</span><br><span class="line">		pool.all[hash] = tx</span><br><span class="line">		pool.priced.Put(tx)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> old != <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-调用queue的add方法替换交易"><a href="#3-1-调用queue的add方法替换交易" class="headerlink" title="3.1 调用queue的add方法替换交易"></a>3.1 调用queue的add方法替换交易</h3><ul>
<li>如果新的交易比老的交易的GasPrice值要高出一定的比值priceBump，那么会替换老的交易。</li>
<li>Add 尝试插入一个新的交易，返回交易是否被接收，如果被接收，那么任意之前的交易会被替换。</li>
<li>如果新的交易被接收，那么总的cost和gas限制会被更新。</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">func (l *txList) Add(tx *types.Transaction, priceBump uint64) (bool, *types.Transaction) &#123;</span><br><span class="line">	// If there&#x27;s an older better transaction, abort</span><br><span class="line">	// 如果存在老的交易。 而且新的交易的价格比老的高出一定的数量。那么替换。</span><br><span class="line">	old := l.txs.Get(tx.Nonce())</span><br><span class="line">	if old != nil &#123;</span><br><span class="line">		threshold := new(big.Int).Div(new(big.Int).Mul(old.GasPrice(), big.NewInt(100+int64(priceBump))), big.NewInt(100))</span><br><span class="line">		// Have to ensure that the new gas price is higher than the old gas</span><br><span class="line">		// price as well as checking the percentage threshold to ensure that</span><br><span class="line">		// this is accurate for low (Wei-level) gas price replacements</span><br><span class="line">		if old.GasPrice().Cmp(tx.GasPrice()) &gt;= 0 || threshold.Cmp(tx.GasPrice()) &gt; 0 &#123;</span><br><span class="line">			return false, nil</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	// Otherwise overwrite the old transaction with the current one</span><br><span class="line">	l.txs.Put(tx)</span><br><span class="line">	if cost := tx.Cost(); l.costcap.Cmp(cost) <span class="tag">&lt; <span class="attr">0</span> &#123;</span></span><br><span class="line"><span class="tag">		<span class="attr">l.costcap</span> = <span class="string">cost</span></span></span><br><span class="line"><span class="tag">	&#125;</span></span><br><span class="line">	if gas := tx.Gas(); l.gascap &lt; gas &#123;</span><br><span class="line">		l.gascap = gas</span><br><span class="line">	&#125;</span><br><span class="line">	return true, old</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-调用promoteExecutables方法将交易插入到pending执行队列中"><a href="#4-调用promoteExecutables方法将交易插入到pending执行队列中" class="headerlink" title="4. 调用promoteExecutables方法将交易插入到pending执行队列中"></a>4. 调用promoteExecutables方法将交易插入到pending执行队列中</h2><p>调用promoteExecutables把已经变得可以执行交易的从queue 列表插入到pending 列表流程如下：</p>
<p><img src="/2020/11/29/EVM_Source/20190320201339647.png" alt="img"></p>
<p>(1)   粉色部分主要是为了把queue中的交易“提”到pending中。在此过程中要做如下检查</p>
<ul>
<li>​    丢弃nonce &lt; 账户当前nonce的交易，也就是已经被打包过的交易</li>
<li>​    丢弃转账金额 + gas消耗 &gt; 账户余额的交易，也就是会out-of-gas的交易</li>
<li>​    丢弃gas limit &gt; block gas limit的交易，这部分交易可能会导致区块生成失败</li>
<li>​    得到所有的可以执行的交易，并promoteTx加入pending并且广播交易</li>
</ul>
<p>(2)  紫色部分主要是为了清理pending列表，使其满足GlobalSlots和AccountSlots的限制条件,需要从以下几个角度进行处理：</p>
<ul>
<li>​    如果有些账户的交易数超过了AccountSlots，则先按交易数最少的账户进行均衡。举例来说，如果有10个账户交易数超过了AccountSlots（默认16），其中交易数最少的账户包含20笔交易，那么先把其他9个账户的交易数量削减到20。</li>
<li>   如果经过上面的步骤，pending的长度还是超过了GlobalSlots，那就严格按照AccountSlots进行均衡，也就是把上面的10个账户的交易数进一步削减到16</li>
</ul>
<p>(3)   绿色部分主要是为了清理queue列表，使其满足GlobalQueue和AccountQueue的限制条件,需要从以下几个角度进行处理：</p>
<ul>
<li>​    如果每个账户的交易数超过了AccountQueue，丢弃多余交易</li>
<li>​    如果queue的长度超过了GlobalQueue，则把账户按最后一次心跳时间排序，然后依次去除账户中的交易，直到满足限制条件位置</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过这个处理过程，所有的无效的交易(nonce太低，余额不足)会被删除。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pool *TxPool)</span> <span class="title">promoteExecutables</span><span class="params">(accounts []common.Address)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Gather all the accounts potentially needing updates</span></span><br><span class="line">	<span class="comment">// accounts存储了所有潜在需要更新的账户。 如果账户传入为nil，代表所有已知的账户。</span></span><br><span class="line">	<span class="keyword">if</span> accounts == <span class="literal">nil</span> &#123;</span><br><span class="line">		accounts = <span class="built_in">make</span>([]common.Address, <span class="number">0</span>, <span class="built_in">len</span>(pool.queue))</span><br><span class="line">		<span class="keyword">for</span> addr := <span class="keyword">range</span> pool.queue &#123;</span><br><span class="line">			accounts = <span class="built_in">append</span>(accounts, addr)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Iterate over all accounts and promote any executable transactions</span></span><br><span class="line">	<span class="keyword">for</span> _, addr := <span class="keyword">range</span> accounts &#123;</span><br><span class="line">		list := pool.queue[addr]</span><br><span class="line">		<span class="keyword">if</span> list == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span> <span class="comment">// Just in case someone calls with a non existing account</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Drop all transactions that are deemed too old (low nonce)</span></span><br><span class="line">		<span class="comment">// 删除所有的nonce太低的交易</span></span><br><span class="line">		<span class="keyword">for</span> _, tx := <span class="keyword">range</span> list.Forward(pool.currentState.GetNonce(addr)) &#123;</span><br><span class="line">			hash := tx.Hash()</span><br><span class="line">			log.Trace(<span class="string">&quot;Removed old queued transaction&quot;</span>, <span class="string">&quot;hash&quot;</span>, hash)</span><br><span class="line">			<span class="built_in">delete</span>(pool.all, hash)</span><br><span class="line">			pool.priced.Removed()</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Drop all transactions that are too costly (low balance or out of gas)</span></span><br><span class="line">		<span class="comment">// 删除所有余额不足的交易。</span></span><br><span class="line">		drops, _ := list.Filter(pool.currentState.GetBalance(addr), pool.currentMaxGas)</span><br><span class="line">		<span class="keyword">for</span> _, tx := <span class="keyword">range</span> drops &#123;</span><br><span class="line">			hash := tx.Hash()</span><br><span class="line">			log.Trace(<span class="string">&quot;Removed unpayable queued transaction&quot;</span>, <span class="string">&quot;hash&quot;</span>, hash)</span><br><span class="line">			<span class="built_in">delete</span>(pool.all, hash)</span><br><span class="line">			pool.priced.Removed()</span><br><span class="line">			queuedNofundsCounter.Inc(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Gather all executable transactions and promote them</span></span><br><span class="line">		<span class="comment">// 得到所有的可以执行的交易，并promoteTx加入pending</span></span><br><span class="line">		<span class="keyword">for</span> _, tx := <span class="keyword">range</span> list.Ready(pool.pendingState.GetNonce(addr)) &#123;</span><br><span class="line">			hash := tx.Hash()</span><br><span class="line">			log.Trace(<span class="string">&quot;Promoting queued transaction&quot;</span>, <span class="string">&quot;hash&quot;</span>, hash)</span><br><span class="line">			pool.promoteTx(addr, hash, tx)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Drop all transactions over the allowed limit</span></span><br><span class="line">		<span class="comment">// 删除所有超过限制的交易</span></span><br><span class="line">		<span class="keyword">if</span> !pool.locals.contains(addr) &#123;</span><br><span class="line">			<span class="keyword">for</span> _, tx := <span class="keyword">range</span> list.Cap(<span class="keyword">int</span>(pool.config.AccountQueue)) &#123;</span><br><span class="line">				hash := tx.Hash()</span><br><span class="line">				<span class="built_in">delete</span>(pool.all, hash)</span><br><span class="line">				pool.priced.Removed()</span><br><span class="line">				queuedRateLimitCounter.Inc(<span class="number">1</span>)</span><br><span class="line">				log.Trace(<span class="string">&quot;Removed cap-exceeding queued transaction&quot;</span>, <span class="string">&quot;hash&quot;</span>, hash)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Delete the entire queue entry if it became empty.</span></span><br><span class="line">		<span class="keyword">if</span> list.Empty() &#123;</span><br><span class="line">			<span class="built_in">delete</span>(pool.queue, addr)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If the pending limit is overflown, start equalizing allowances</span></span><br><span class="line">	pending := <span class="keyword">uint64</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> _, list := <span class="keyword">range</span> pool.pending &#123;</span><br><span class="line">		pending += <span class="keyword">uint64</span>(list.Len())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 如果pending的总数超过系统的配置。</span></span><br><span class="line">	<span class="keyword">if</span> pending &gt; pool.config.GlobalSlots &#123;</span><br><span class="line">		pendingBeforeCap := pending</span><br><span class="line">		<span class="comment">// Assemble a spam order to penalize large transactors first</span></span><br><span class="line">		spammers := prque.New()</span><br><span class="line">		<span class="keyword">for</span> addr, list := <span class="keyword">range</span> pool.pending &#123;</span><br><span class="line">			<span class="comment">// Only evict transactions from high rollers</span></span><br><span class="line">			<span class="comment">// 首先把所有大于AccountSlots最小值的账户记录下来， 会从这些账户里面剔除一些交易。</span></span><br><span class="line">			<span class="comment">// 注意spammers是一个优先级队列，也就是说是按照交易的多少从大到小排序的。</span></span><br><span class="line">			<span class="keyword">if</span> !pool.locals.contains(addr) &amp;&amp; <span class="keyword">uint64</span>(list.Len()) &gt; pool.config.AccountSlots &#123;</span><br><span class="line">				spammers.Push(addr, <span class="keyword">float32</span>(list.Len()))</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Gradually drop transactions from offenders</span></span><br><span class="line">		offenders := []common.Address&#123;&#125;</span><br><span class="line">		<span class="keyword">for</span> pending &gt; pool.config.GlobalSlots &amp;&amp; !spammers.Empty() &#123;</span><br><span class="line">			<span class="comment">// Retrieve the next offender if not local address</span></span><br><span class="line">			offender, _ := spammers.Pop()</span><br><span class="line">			offenders = <span class="built_in">append</span>(offenders, offender.(common.Address))</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// Equalize balances until all the same or below threshold</span></span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(offenders) &gt; <span class="number">1</span> &#123; <span class="comment">// 第一次进入这个循环的时候， offenders队列里面有交易数量最大的两个账户</span></span><br><span class="line">				<span class="comment">// Calculate the equalization threshold for all current offenders</span></span><br><span class="line">				<span class="comment">// 把最后加入的账户的交易数量当成本次的阈值t</span></span><br><span class="line">				threshold := pool.pending[offender.(common.Address)].Len()</span><br><span class="line"> </span><br><span class="line">				<span class="comment">// Iteratively reduce all offenders until below limit or threshold reached</span></span><br><span class="line">				<span class="comment">// 遍历直到pending有效，或者是倒数第二个的交易数量等于最后一个的交易数量</span></span><br><span class="line">				<span class="keyword">for</span> pending &gt; pool.config.GlobalSlots &amp;&amp; pool.pending[offenders[<span class="built_in">len</span>(offenders)<span class="number">-2</span>]].Len() &gt; threshold &#123;</span><br><span class="line">					<span class="comment">// 遍历除了最后一个账户以外的所有账户， 把他们的交易数量减去1.</span></span><br><span class="line">					<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(offenders)<span class="number">-1</span>; i++ &#123;</span><br><span class="line">						list := pool.pending[offenders[i]]</span><br><span class="line">						<span class="keyword">for</span> _, tx := <span class="keyword">range</span> list.Cap(list.Len() - <span class="number">1</span>) &#123;</span><br><span class="line">							<span class="comment">// Drop the transaction from the global pools too</span></span><br><span class="line">							hash := tx.Hash()</span><br><span class="line">							<span class="built_in">delete</span>(pool.all, hash)</span><br><span class="line">							pool.priced.Removed()</span><br><span class="line"> </span><br><span class="line">							<span class="comment">// Update the account nonce to the dropped transaction</span></span><br><span class="line">							<span class="keyword">if</span> nonce := tx.Nonce(); pool.pendingState.GetNonce(offenders[i]) &gt; nonce &#123;</span><br><span class="line">								pool.pendingState.SetNonce(offenders[i], nonce)</span><br><span class="line">							&#125;</span><br><span class="line">							log.Trace(<span class="string">&quot;Removed fairness-exceeding pending transaction&quot;</span>, <span class="string">&quot;hash&quot;</span>, hash)</span><br><span class="line">						&#125;</span><br><span class="line">						pending--</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// If still above threshold, reduce to limit or min allowance</span></span><br><span class="line">		<span class="keyword">if</span> pending &gt; pool.config.GlobalSlots &amp;&amp; <span class="built_in">len</span>(offenders) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> pending &gt; pool.config.GlobalSlots &amp;&amp; <span class="keyword">uint64</span>(pool.pending[offenders[<span class="built_in">len</span>(offenders)<span class="number">-1</span>]].Len()) &gt; pool.config.AccountSlots &#123;</span><br><span class="line">				<span class="keyword">for</span> _, addr := <span class="keyword">range</span> offenders &#123;</span><br><span class="line">					list := pool.pending[addr]</span><br><span class="line">					<span class="keyword">for</span> _, tx := <span class="keyword">range</span> list.Cap(list.Len() - <span class="number">1</span>) &#123;</span><br><span class="line">						<span class="comment">// Drop the transaction from the global pools too</span></span><br><span class="line">						hash := tx.Hash()</span><br><span class="line">						<span class="built_in">delete</span>(pool.all, hash)</span><br><span class="line">						pool.priced.Removed()</span><br><span class="line"> </span><br><span class="line">						<span class="comment">// Update the account nonce to the dropped transaction</span></span><br><span class="line">						<span class="keyword">if</span> nonce := tx.Nonce(); pool.pendingState.GetNonce(addr) &gt; nonce &#123;</span><br><span class="line">							pool.pendingState.SetNonce(addr, nonce)</span><br><span class="line">						&#125;</span><br><span class="line">						log.Trace(<span class="string">&quot;Removed fairness-exceeding pending transaction&quot;</span>, <span class="string">&quot;hash&quot;</span>, hash)</span><br><span class="line">					&#125;</span><br><span class="line">					pending--</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		pendingRateLimitCounter.Inc(<span class="keyword">int64</span>(pendingBeforeCap - pending))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If we&#x27;ve queued more transactions than the hard limit, drop oldest ones</span></span><br><span class="line">	queued := <span class="keyword">uint64</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> _, list := <span class="keyword">range</span> pool.queue &#123;</span><br><span class="line">		queued += <span class="keyword">uint64</span>(list.Len())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> queued &gt; pool.config.GlobalQueue &#123;</span><br><span class="line">		<span class="comment">// Sort all accounts with queued transactions by heartbeat</span></span><br><span class="line">		addresses := <span class="built_in">make</span>(addresssByHeartbeat, <span class="number">0</span>, <span class="built_in">len</span>(pool.queue))</span><br><span class="line">		<span class="keyword">for</span> addr := <span class="keyword">range</span> pool.queue &#123;</span><br><span class="line">			<span class="keyword">if</span> !pool.locals.contains(addr) &#123; <span class="comment">// don&#x27;t drop locals</span></span><br><span class="line">				addresses = <span class="built_in">append</span>(addresses, addressByHeartbeat&#123;addr, pool.beats[addr]&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		sort.Sort(addresses)</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// Drop transactions until the total is below the limit or only locals remain</span></span><br><span class="line">		<span class="keyword">for</span> drop := queued - pool.config.GlobalQueue; drop &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(addresses) &gt; <span class="number">0</span>; &#123;</span><br><span class="line">			addr := addresses[<span class="built_in">len</span>(addresses)<span class="number">-1</span>]</span><br><span class="line">			list := pool.queue[addr.address]</span><br><span class="line"> </span><br><span class="line">			addresses = addresses[:<span class="built_in">len</span>(addresses)<span class="number">-1</span>]</span><br><span class="line"> </span><br><span class="line">			<span class="comment">// Drop all transactions if they are less than the overflow</span></span><br><span class="line">			<span class="keyword">if</span> size := <span class="keyword">uint64</span>(list.Len()); size &lt;= drop &#123;</span><br><span class="line">				<span class="keyword">for</span> _, tx := <span class="keyword">range</span> list.Flatten() &#123;</span><br><span class="line">					pool.removeTx(tx.Hash(), <span class="literal">true</span>)</span><br><span class="line">				&#125;</span><br><span class="line">				drop -= size</span><br><span class="line">				queuedRateLimitCounter.Inc(<span class="keyword">int64</span>(size))</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// Otherwise drop only last few transactions</span></span><br><span class="line">			txs := list.Flatten()</span><br><span class="line">			<span class="keyword">for</span> i := <span class="built_in">len</span>(txs) - <span class="number">1</span>; i &gt;= <span class="number">0</span> &amp;&amp; drop &gt; <span class="number">0</span>; i-- &#123;</span><br><span class="line">				pool.removeTx(txs[i].Hash(), <span class="literal">true</span>)</span><br><span class="line">				drop--</span><br><span class="line">				queuedRateLimitCounter.Inc(<span class="number">1</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-调用promoteTx将交易广播到其他节点"><a href="#4-1-调用promoteTx将交易广播到其他节点" class="headerlink" title="4.1 调用promoteTx将交易广播到其他节点"></a>4.1 调用promoteTx将交易广播到其他节点</h3><p>主要步骤如下：</p>
<ul>
<li>获取正在执行队列中该地址的所有交易</li>
<li>用当前交易替换已存在的比较老的交易</li>
<li>如果交易池中不存在当前交易，将该交易添加到all队列中</li>
<li>设置更新交易的nonce</li>
<li>最后调用grpc接口，将交易广播到其他节点</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pool *TxPool)</span> <span class="title">promoteTx</span><span class="params">(addr common.Address, hash common.Hash, tx *types.Transaction)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Try to insert the transaction into the pending queue</span></span><br><span class="line">	<span class="keyword">if</span> pool.pending[addr] == <span class="literal">nil</span> &#123;</span><br><span class="line">		pool.pending[addr] = newTxList(<span class="literal">true</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	list := pool.pending[addr]</span><br><span class="line">	inserted, old := list.Add(tx, pool.config.PriceBump)</span><br><span class="line">	<span class="keyword">if</span> !inserted &#123;</span><br><span class="line">		<span class="comment">// An older transaction was better, discard this</span></span><br><span class="line">		<span class="built_in">delete</span>(pool.all, hash)</span><br><span class="line">		pool.priced.Removed()</span><br><span class="line">		pendingDiscardCounter.Inc(<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Otherwise discard any previous transaction and mark this</span></span><br><span class="line">	<span class="keyword">if</span> old != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">delete</span>(pool.all, old.Hash())</span><br><span class="line">		pool.priced.Removed()</span><br><span class="line">		pendingReplaceCounter.Inc(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Failsafe to work around direct pending inserts (tests)</span></span><br><span class="line">	<span class="keyword">if</span> pool.all[hash] == <span class="literal">nil</span> &#123;</span><br><span class="line">	pool.all[hash] = tx</span><br><span class="line">	pool.priced.Put(tx)</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Set the potentially new pending nonce and notify any subsystems of the new tx</span></span><br><span class="line">	pool.beats[addr] = time.Now()</span><br><span class="line">	pool.pendingState.SetNonce(addr, tx.Nonce()+<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">go</span> pool.txFeed.Send(TxPreEvent&#123;tx&#125;)</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BlockChain/" rel="tag">BlockChain</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/EVM/" rel="tag">EVM</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-fabric"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/25/fabric/"
    >Hyperledger Fabric - 01 - 安装并测试网络</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/25/fabric/" class="article-date">
  <time datetime="2020-11-25T02:31:23.000Z" itemprop="datePublished">2020-11-25</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/BlockChain/">BlockChain</a> / <a class="article-category-link" href="/categories/BlockChain/Hyperledger-Fabric/">Hyperledger Fabric</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="Hyperledger-Fabric-搭建并测试"><a href="#Hyperledger-Fabric-搭建并测试" class="headerlink" title="Hyperledger Fabric 搭建并测试"></a>Hyperledger Fabric 搭建并测试</h1><h2 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备</h2><table>
<thead>
<tr>
<th>系统工具</th>
<th>版本</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>CentOS</td>
<td>7</td>
<td></td>
</tr>
<tr>
<td>Docker</td>
<td>18.09.4</td>
<td>参考：<a target="_blank" rel="noopener" href="https://zzugo.ayxyj.cn/2020/11/01/docker/">Centps7安装docker</a></td>
</tr>
<tr>
<td>Docker-compose</td>
<td>1.25.0</td>
<td>参考下方</td>
</tr>
<tr>
<td>GO</td>
<td>1.13.4</td>
<td>参考：<a target="_blank" rel="noopener" href="https://golang.org/dl/">CentOS7下载Go</a> 解压配置环境变量即可</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装docker-compose</span></span><br><span class="line"><span class="comment">#方式一：</span></span><br><span class="line">curl -L https://github.com/docker/compose/releases/download/1.25.0-rc1/docker-compose-`uname -s`-`uname -m` -o /usr/<span class="built_in">local</span>/bin/docker-compose </span><br><span class="line">sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"><span class="comment">#方式二：</span></span><br><span class="line">pip install -U docker-compose==1.23.2</span><br></pre></td></tr></table></figure>

<h2 id="二、安装fabric2-x"><a href="#二、安装fabric2-x" class="headerlink" title="二、安装fabric2.x"></a>二、安装fabric2.x</h2><ul>
<li>首先，自行下载fabric源码<a target="_blank" rel="noopener" href="https://github.com/hyperledger/fabric.git">git clone</a>，将下载的fabric包解压出来，进入到<code>$&#123;HOME&#125;/fabric/scripts</code>脚本目录进行安装</li>
</ul>
<p><img src="/2020/11/25/fabric/1.png" alt="1"></p>
<ul>
<li>下载过程比较漫长，因为采用的是docker镜像容器进行安装，需要下载所需要的镜像，我这里面拉取了所有的镜像，很多暂时不用（2.x不支持kafka,zookeeper）</li>
</ul>
<ul>
<li>脚本执行结束后，可以看到相关镜像等其他信息，如果存在没有拉取完的镜像，就在执行一边。</li>
</ul>
<p><img src="/2020/11/25/fabric/2.png" alt="2"></p>
<ul>
<li>通过docker查看拉取的镜像信息<code>docker image ls -a</code></li>
</ul>
<p><img src="/2020/11/25/fabric/3.png" alt="3"></p>
<p>执行完如上图，另外在scripts目录下会多出来一个fabric-samples目录</p>
<h2 id="三、启动test-network测试网络"><a href="#三、启动test-network测试网络" class="headerlink" title="三、启动test-network测试网络"></a>三、启动test-network测试网络</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /fabric-samples/test-network</span><br><span class="line">network.sh up</span><br></pre></td></tr></table></figure>

<p>如下图，表示启动成功，已启动一个orderer节点和两个peer节点。</p>
<p><img src="/2020/11/25/fabric/4.png" alt="4"></p>
<p>可以查看本地启动的docker container 存在测试网络启动的oder和peer</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a  <span class="comment">#查看启动的container</span></span><br><span class="line">docker container ls -a <span class="comment">#查看启动的container</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/25/fabric/5.png" alt="5"></p>
<h2 id="四、使用测试网络"><a href="#四、使用测试网络" class="headerlink" title="四、使用测试网络"></a>四、使用测试网络</h2><ul>
<li>创建channel，使用network.sh脚本创建来创建一个连接org1和org2组织并加入他们peer的通道，命令如下：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./network.sh createChannel</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/25/fabric/6.png" alt="6"></p>
<p><img src="/2020/11/25/fabric/7.png" alt="7"></p>
<p>如上图，创建成功（默认通道名为mychannel）。</p>
<p>也可以带上channel标签，命令如下（-c channelName）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./network.sh createChannel -c channel1</span><br></pre></td></tr></table></figure>

<p>如果要在一个步骤中启动网络并创建频道，可以同时使用up和create channel模式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./network.sh up createChannel</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li>在通道上启动链码。</li>
</ul>
<p>使用network.sh创建通道之后，可以使用以下命令在通道上启动链码（默认使用go语言）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./network.sh deployCC</span><br></pre></td></tr></table></figure>

<p>可以指定语言，加-l ，比如用java，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./network.sh deployCC -l java</span><br></pre></td></tr></table></figure>

<p>如图，启动成功：</p>
<p><img src="/2020/11/25/fabric/8.png" alt="8"></p>
<ul>
<li>与网络互动</li>
</ul>
<p>网络启动之后，可以使用peer cli客户端去操作网络，可以通过cli客户端去调用部署智能合约，更新通道，或者安装和部署新的智能合约。</p>
<p>首先确保<code>操作目录为test-network目录</code>。使用以下命令将二进制文件添加到cli路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;PWD&#125;</span>/../bin:<span class="variable">$&#123;PWD&#125;</span>:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p>还需要设置<code>FABRIC_CFG_PATH路径指向fabric-samples中的core.yaml文件，命令如下：</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> FABRIC_CFG_PATH=<span class="variable">$PWD</span>/../config/</span><br></pre></td></tr></table></figure>

<p>设置允许org1操作peer cli的环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Environment variables for Org1</span></span><br><span class="line"><span class="built_in">export</span> CORE_PEER_TLS_ENABLED=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> CORE_PEER_LOCALMSPID=<span class="string">&quot;Org1MSP&quot;</span></span><br><span class="line"><span class="built_in">export</span> CORE_PEER_TLS_ROOTCERT_FILE=<span class="variable">$&#123;PWD&#125;</span>/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt</span><br><span class="line"><span class="built_in">export</span> CORE_PEER_ADDRESS=localhost:7051</span><br><span class="line"><span class="built_in">export</span> CORE_PEER_MSPCONFIGPATH=<span class="variable">$&#123;PWD&#125;</span>/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</span><br></pre></td></tr></table></figure>

<p>如上，<code>CORE_PEER_TLS_ROOTCERT_FILE和CORE_PEER_MSPCONFIGPATH环境变量指向organizations文件夹中的org1的加密文件。</code></p>
<p>使用以下命令获取汽车资产列表：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode query -C mychannel -n fabcar -c <span class="string">&#x27;&#123;&quot;Args&quot;:[&quot;queryAllCars&quot;]&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="五、关闭网络"><a href="#五、关闭网络" class="headerlink" title="五、关闭网络"></a>五、关闭网络</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./network.sh down</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/25/fabric/10.png" alt="10"></p>
<h3 id="启动过程详解"><a href="#启动过程详解" class="headerlink" title="启动过程详解"></a>启动过程详解</h3><ul>
<li><code>./network.sh</code>为两个peer节点和一个order节点创建了证书和密钥，默认情况下，脚本会利用在organizations/cryptogen文件夹下的加密工具。</li>
<li>脚本利用configtxgen工具创建了系统的创世块，它使用<code>configtx/configtx.yaml</code>文件来创建创世块，并存储在system-genesis-block文件夹中。</li>
<li>当上述两步完成之后，<code>./network.sh</code>会启动网络，脚本利用在docker文件夹下的<code>docker-compose-test-net.yaml</code>文件创建peer和orderer节点。</li>
<li>如果使用了<code>createChannel</code>子命令，脚本还会运行script文件夹下的<code>createChannel.sh</code>脚本来创建所需要的channel，脚本会用peer命令来创建channel，加入两个组织。</li>
<li>如果运行了deployCC命令，脚本会在所有peers上运行script下的<code>deployCC.sh</code>脚本来安装fabcar chaincode，在chaincode的定义被提交到channel之后，peer命令会调用init函数来初始化chaincode，并将所需的数据放入chaincode中。</li>
</ul>
<p>注：下图是fabric简化交易过程</p>
<p><img src="/2020/11/25/fabric/11.png" alt="11"></p>
<h2 id="六、标志并启动网络（ca为网络的标志）"><a href="#六、标志并启动网络（ca为网络的标志）" class="headerlink" title="六、标志并启动网络（ca为网络的标志）"></a>六、标志并启动网络（ca为网络的标志）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./network.sh up -ca</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/25/fabric/Users/AYXYJ/Desktop/fabric/hyperledger%20fabric%20note/fabric/12.png" alt="标志并启动网络"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BlockChain/" rel="tag">BlockChain</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hyperledger-Fabric/" rel="tag">Hyperledger Fabric</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-docker_的私有registry"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/23/docker_%E7%9A%84%E7%A7%81%E6%9C%89registry/"
    >Docker Registry - 搭建本地仓库并测试</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/23/docker_%E7%9A%84%E7%A7%81%E6%9C%89registry/" class="article-date">
  <time datetime="2020-11-23T06:24:15.000Z" itemprop="datePublished">2020-11-23</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Docker/">Docker</a> / <a class="article-category-link" href="/categories/Docker/Registry/">Registry</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="搭建一个私有的docker-registry"><a href="#搭建一个私有的docker-registry" class="headerlink" title="搭建一个私有的docker registry"></a>搭建一个私有的docker registry</h1><p>找一台docker host，然后运行 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -v /opt/registry:/var/lib/registry -p 5000:5000 --restart=always --name registry registry:2</span><br></pre></td></tr></table></figure>

<p>docker registry 绑定了到本地的80端口。 接下来我们配置DNS server，假如我们这台运行registry的机器地址是192.168.99.100,</p>
<p>然后我们找到上次配置gitlab ci的那个dns container</p>
<p>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it dns-server &#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure>

<p>添加一条新的记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F; # more &#x2F;etc&#x2F;dnsmasqhosts</span><br><span class="line">192.168.211.10 gitlab.example.com</span><br><span class="line">192.168.99.100 registry.example.com</span><br><span class="line">&#x2F; #</span><br></pre></td></tr></table></figure>

<p>然后重启container</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart dns-server</span><br></pre></td></tr></table></figure>

<p>最后我们去gitlab-ci服务器，ping一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[vagrant@gitlab-ci ~]$ ping registry.example.com</span><br><span class="line">PING registry.example.com (192.168.99.100) 56(84) bytes of data.</span><br><span class="line">64 bytes from registry.example.com (192.168.99.100): icmp_seq&#x3D;1 ttl&#x3D;63 time&#x3D;0.395 ms</span><br><span class="line">64 bytes from registry.example.com (192.168.99.100): icmp_seq&#x3D;2 ttl&#x3D;63 time&#x3D;0.537 ms</span><br><span class="line">64 bytes from registry.example.com (192.168.99.100): icmp_seq&#x3D;3 ttl&#x3D;63 time&#x3D;0.683 ms</span><br><span class="line">^C</span><br><span class="line">--- registry.example.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2003ms</span><br><span class="line">rtt min&#x2F;avg&#x2F;max&#x2F;mdev &#x3D; 0.395&#x2F;0.538&#x2F;0.683&#x2F;0.119 ms</span><br><span class="line">[vagrant@gitlab-ci ~]$</span><br></pre></td></tr></table></figure>

<p>成功。</p>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p>在gitlab-ci服务器上，编辑</p>
<p>创建一个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br></pre></td></tr></table></figure>

<p>然后写入内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[vagrant@gitlab-ci ~]$ sudo more &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br><span class="line">&#123; &quot;insecure-registries&quot;:[&quot;registry.example.com:5000&quot;] &#125;</span><br><span class="line">[vagrant@gitlab-ci ~]$</span><br></pre></td></tr></table></figure>

<p>从docker hub拉取一个busybox，然后打一个tag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull busybox</span><br><span class="line">docker tag busybox registry.example.com:5000&#x2F;busybox</span><br></pre></td></tr></table></figure>

<p>然后push到我们的私有registry里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[vagrant@gitlab-ci ~]$ docker push registry.example.com:5000&#x2F;busybox</span><br><span class="line">The push refers to repository [registry.example.com:5000&#x2F;busybox]</span><br><span class="line">c5183829c43c: Pushed</span><br><span class="line">latest: digest: sha256:c7b0a24019b0e6eda714ec0fa137ad42bc44a754d9cea17d14fba3a80ccc1ee4 size: 527</span><br><span class="line">[vagrant@gitlab-ci ~]$</span><br></pre></td></tr></table></figure>

<p>成功。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Registry/" rel="tag">Registry</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-docker-portainer"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/22/docker-portainer/"
    >Docker Portainer - 安装并远程连接docker-WebUI</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/22/docker-portainer/" class="article-date">
  <time datetime="2020-11-22T02:31:23.000Z" itemprop="datePublished">2020-11-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Docker/">Docker</a> / <a class="article-category-link" href="/categories/Docker/Portainer/">Portainer</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="Centos7远程访问系统中的docker-WebUI工具Portainer"><a href="#Centos7远程访问系统中的docker-WebUI工具Portainer" class="headerlink" title="Centos7远程访问系统中的docker-WebUI工具Portainer"></a>Centos7远程访问系统中的docker-WebUI工具Portainer</h2><p>首先获取portainer image </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull portainer/portainer</span><br></pre></td></tr></table></figure>

<p>新建一个卷（portainer_data）来存Portainer数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker volume create portainer_data</span><br><span class="line">docker run -d -p 9000:9000 -p 8000:8000 --name portainer --restart always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer </span><br><span class="line"></span><br><span class="line"><span class="comment">#第二种本地存储</span></span><br><span class="line">docker run -d --restart=always -p 9000:9000 -v /root/portainer:/data -v /var/run/docker.sock:/var/run/docker.sock --name dev-portainer portainer/portainer</span><br></pre></td></tr></table></figure>

<p>修改将要被远程连接的客户机的docker.service 文件开通docker的远程管理：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /lib/systemd/system/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd -H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375</span><br></pre></td></tr></table></figure>

<p>重启客户机docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<p>关闭客户机防火墙</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">查看防火墙状态： systemctl status firewalld.service  <span class="comment">#绿的running表示防火墙开启</span></span><br><span class="line"></span><br><span class="line">执行关闭命令： systemctl stop firewalld.service</span><br><span class="line"></span><br><span class="line">再次执行查看防火墙命令：systemctl status firewalld.service</span><br><span class="line"></span><br><span class="line">执行开机禁用防火墙自启命令  ： systemctl <span class="built_in">disable</span> firewalld.service</span><br></pre></td></tr></table></figure>

<p>查看端口信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ss -ntpl</span><br><span class="line"><span class="comment">#存在2375即可访问</span></span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Portainer/" rel="tag">Portainer</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-solidity-02"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/18/solidity-02/"
    >Solidity - 02 - 基本语法</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/18/solidity-02/" class="article-date">
  <time datetime="2020-11-18T04:36:42.000Z" itemprop="datePublished">2020-11-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/BlockChain/">BlockChain</a> / <a class="article-category-link" href="/categories/BlockChain/Solidity/">Solidity</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="元素的可见性"><a href="#元素的可见性" class="headerlink" title="元素的可见性"></a>元素的可见性</h1><p>private 修饰的函数为私有的，只有合约内部可以调用</p>
<p>Public修饰的函数为共有的，合约内外都可以调用</p>
<p>public/private 可以修饰状态变量</p>
<p>状态变量默认是私有的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract  Test &#123;</span><br><span class="line">    <span class="comment">//状态变量</span></span><br><span class="line">    <span class="comment">//类型不匹配时需要显示转换类型</span></span><br><span class="line">    <span class="comment">//返回值需要使用returns描述</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//public/private 可以修饰状态变量</span></span><br><span class="line">    <span class="comment">//状态变量默认是私有的</span></span><br><span class="line">    uint256 public ui256 = <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    int8 private i10 = -<span class="number">10</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//private 修饰的函数为私有的，只有合约内部可以调用</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"></span>) <span class="title">private</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ui256 + uint256(i10);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">isEqueal</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">bool</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ui256 == uint256(i10);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Public修饰的函数为共有的，合约内外都可以调用</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Add</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint256</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> add();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="View，Constant，Pure介绍"><a href="#View，Constant，Pure介绍" class="headerlink" title="View，Constant，Pure介绍"></a>View，Constant，Pure介绍</h1><p> ==//在constant/view 修饰函数的函数中，如果去修改了状态变量，编译器不会报错，但是赋值不会成功(坑！！！！）==</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract  Test &#123;</span><br><span class="line">    <span class="comment">//状态变量</span></span><br><span class="line">    <span class="comment">//类型不匹配时需要显示转换类型</span></span><br><span class="line">    <span class="comment">//返回值需要使用returns描述</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//public/private 可以修饰状态变量</span></span><br><span class="line">    <span class="comment">//状态变量默认是私有的</span></span><br><span class="line">    uint256 public ui = <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    int8 private i10 = <span class="number">10</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 如果函数中没有用到状态变量：（既没有读也没有写），就修饰为pure</span></span><br><span class="line">    <span class="comment">// 2. 如果读了，但是没写，修饰为view、constant</span></span><br><span class="line">    <span class="comment">// 3. 如果写了，那么不修饰即可</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">constant</span> <span class="title">returns</span>(<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ui + uint256(i10);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">pure</span> <span class="title">returns</span>(<span class="params">string</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setValue</span>(<span class="params">uint256 num</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        ui = num;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//在constant/view 修饰函数的函数中，如果去修改了状态变量，编译器不会报错，但是赋值不会成功(坑！！！！）</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setValue1</span>(<span class="params">uint256 num</span>) <span class="title">public</span> <span class="title">constant</span> </span>&#123;</span><br><span class="line">        ui = num;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">isEqueal</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">bool</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ui == uint256(i10);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="payable关键字"><a href="#payable关键字" class="headerlink" title="payable关键字"></a>payable关键字</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract  Test &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">string</span> public str ;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//修饰为payable的函数才可以接收转账</span></span><br><span class="line">    <span class="comment">//不指定payable无法接收</span></span><br><span class="line">    function test1(<span class="keyword">string</span> src) public payable &#123;</span><br><span class="line">        str = src;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function test2(<span class="keyword">string</span> src) public &#123;</span><br><span class="line">        str = src;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function getbalance() public view returns(uint256) &#123;</span><br><span class="line">        <span class="comment">//this代表当前合约本身</span></span><br><span class="line">        <span class="comment">//balance方法，获取当前合约的余额</span></span><br><span class="line">        <span class="keyword">return</span> this.balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="地址获取余额balance"><a href="#地址获取余额balance" class="headerlink" title="地址获取余额balance"></a>地址获取余额balance</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract  Test &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    address public addr1 = <span class="number">0x0014723a09acff6d2a60dcdf7aa4aff308fddc160c</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//地址address类型本质上是一个160位的数字</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//可以进行加减，需要强制转换</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint160</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> uint160(addr1) + <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//1. 匿名函数：没有函数名，没有参数，没有返回值的函数，就是匿名函数</span></span><br><span class="line">    <span class="comment">//2. 当调用一个不存在的方法时，合约会默认的去调用匿名函数</span></span><br><span class="line">    <span class="comment">//3. 匿名函数一般用来给合约转账，因为费用低</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">public</span>  <span class="title">payable</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getBalance</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> addr1.balance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getContractBalance</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//this代表当前合约本身</span></span><br><span class="line">        <span class="comment">//balance方法，获取当前合约的余额</span></span><br><span class="line">        <span class="keyword">return</span> address(<span class="built_in">this</span>).balance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="地址转账"><a href="#地址转账" class="headerlink" title="地址转账"></a>地址转账</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract  Test &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    address public addr0 = <span class="number">0x00ca35b7d915458ef540ade6068dfe2f44e8fa733c</span>;</span><br><span class="line">    address public addr1 = <span class="number">0x0014723a09acff6d2a60dcdf7aa4aff308fddc160c</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//1. 匿名函数：没有函数名，没有参数，没有返回值的函数，就是匿名函数</span></span><br><span class="line">    <span class="comment">//2. 当调用一个不存在的方法时，合约会默认的去调用匿名函数</span></span><br><span class="line">    <span class="comment">//3. 匿名函数一般用来给合约转账，因为费用低</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">public</span>  <span class="title">payable</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getBalance</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> addr1.balance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getContractBalance</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> address(<span class="built_in">this</span>).balance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//由合约向addr1 转账10以太币</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1. 转账的时候单位是wei</span></span><br><span class="line">        <span class="comment">//2. 1 ether = 10 ^18 wei （10的18次方）</span></span><br><span class="line">        <span class="comment">//3. 向谁转钱，就用谁调用tranfer函数</span></span><br><span class="line">        <span class="comment">//4. 花费的是合约的钱</span></span><br><span class="line">        <span class="comment">//5. 如果金额不足，transfer函数会抛出异常</span></span><br><span class="line">        addr1.transfer(<span class="number">10</span> * <span class="number">10</span> **<span class="number">18</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//send转账与tranfer使用方式一致，但是如果转账金额不足，不会抛出异常，而是会返回false</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">sendTest</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        addr1.send(<span class="number">10</span> * <span class="number">10</span> **<span class="number">18</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="bytes1：内置的固定长度的字节数组"><a href="#bytes1：内置的固定长度的字节数组" class="headerlink" title="bytes1：内置的固定长度的字节数组"></a>bytes1：内置的固定长度的字节数组</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract  Test &#123;</span><br><span class="line"></span><br><span class="line">    bytes1 b1 =<span class="string">&quot;h&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    bytes20 b10 = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line"></span><br><span class="line">    function getLen() public view returns(uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> b10.length;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function setValue() private pure &#123;</span><br><span class="line">        <span class="comment">//1. 固定长度数组可以通过下标访问</span></span><br><span class="line">        <span class="comment">//2. 只能读取，不能写</span></span><br><span class="line">        <span class="comment">//b10[0] = v;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3. 存储的时候是ascii值存储</span></span><br><span class="line">    function getValue(uint256 i) public view returns(<span class="keyword">byte</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> b10[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="bytes动态字节数组"><a href="#bytes动态字节数组" class="headerlink" title="bytes动态字节数组"></a>bytes动态字节数组</h1><ol>
<li><p>可以不分空间，直接进行字符串赋值，会自动分配空间</p>
</li>
<li><p>如果未分配过空间，使用下标访问会访问越界报错</p>
</li>
<li><p>可以设置长度，自动分配对应空间，并且初始化为0</p>
</li>
<li><p>可以通过下标进行数据修改</p>
</li>
<li><p>支持push操作，在bytes最后面追加元素</p>
</li>
</ol>
<p>注意的坑：</p>
<p><strong>旧版本的remix可以直接在remix中使用”helloworld”形式给bytes赋值，新版本不允许，必须使用0x格式</strong></p>
<p>例如，如果函数类型为：byte b1, 那么赋值时需要输入的格式为：  “h”（旧版本）, 0x68(新版本)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract  Test &#123;</span><br><span class="line"></span><br><span class="line">    bytes public name;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getLen</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. 可以不分空间，直接进行字符串赋值，会自动分配空间</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setValue</span>(<span class="params">bytes input</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        name = input;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2. 如果未分配过空间，使用下标访问会访问越界报错</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getByIndex</span>(<span class="params">uint256 i</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">byte</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name[i];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3. 可以设置长度，自动分配对应空间，并且初始化为0</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setLen</span>(<span class="params">uint256 len</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        name.length = len;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//4.可以通过下标进行数据修改</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setValue2</span>(<span class="params">uint256 i</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        name[i] = <span class="string">&#x27;h&#x27;</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//5. 支持push操作，在bytes最后面追加元素</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">pushData</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        name.push(<span class="string">&#x27;h&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="string"><a href="#string" class="headerlink" title="string"></a>string</h1><ul>
<li>动态尺寸的UTF-8编码字符串，是特殊的可变字节数组</li>
<li>引用类型</li>
<li><strong>不支持下标索引</strong></li>
<li><strong>不支持length、push方法</strong></li>
<li><strong>可以修改(需通过bytes转换)</strong></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract  Test &#123;</span><br><span class="line"></span><br><span class="line">    string public name = <span class="string">&quot;lily&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setName</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        bytes(name)[<span class="number">0</span>] = <span class="string">&quot;L&quot;</span>;   </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getLength</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bytes(name).length;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setLength</span>(<span class="params">uint256 i</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        bytes(name).length = i;</span><br><span class="line">        </span><br><span class="line">        bytes(name)[i - <span class="number">1</span>] = <span class="string">&#x27;H&#x27;</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="storageVsMemory关键字"><a href="#storageVsMemory关键字" class="headerlink" title="storageVsMemory关键字"></a>storageVsMemory关键字</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract  Test &#123;</span><br><span class="line">    string public name = <span class="string">&quot;lily&quot;</span>;</span><br><span class="line">    uint256 public num = <span class="number">10</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">call1</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        setName(name);    </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//对于引用类型数据，作为函数参数时，默认是memory类型（值传递）</span></span><br><span class="line">    <span class="comment">//function setName(string input) private &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setName</span>(<span class="params">string memory input</span>) <span class="title">private</span> </span>&#123;</span><br><span class="line">        num = <span class="number">20</span>;</span><br><span class="line">        bytes(input)[<span class="number">0</span>] = <span class="string">&quot;L&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">call2</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        setName2(name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2. 如果想引用传递，那么需要明确指定为stroage类型</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setName2</span>(<span class="params">string storage input</span>) <span class="title">private</span> </span>&#123;</span><br><span class="line">        num = <span class="number">30</span>;</span><br><span class="line">        bytes(input)[<span class="number">0</span>] = <span class="string">&quot;L&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果局部变量是string，数组，结构体类型数据，默认情况下是storage类型</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">localTest</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="comment">//string tmp = name;</span></span><br><span class="line">        string storage tmp = name;</span><br><span class="line">        num = <span class="number">40</span>;</span><br><span class="line">        bytes(tmp)[<span class="number">0</span>] = <span class="string">&quot;L&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">localTest1</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//也可以明确设置为memory类型</span></span><br><span class="line">        string memory tmp = name;</span><br><span class="line">        num = <span class="number">50</span>;</span><br><span class="line">        bytes(tmp)[<span class="number">0</span>] = <span class="string">&quot;L&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="byte1BytesString相互转换"><a href="#byte1BytesString相互转换" class="headerlink" title="byte1BytesString相互转换"></a>byte1BytesString相互转换</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract  Test &#123;</span><br><span class="line">    </span><br><span class="line">    bytes10 public b10 = <span class="number">0x68656c6c6f776f726c64</span>; <span class="comment">//helloworld</span></span><br><span class="line">    </span><br><span class="line">    bytes public bs10 = <span class="keyword">new</span> bytes(b10.length);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将固定长度数组的值赋值给不定长度数组</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fixedByteToBytes</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="comment">//bs10 = b10;</span></span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; b10.length; i++) &#123;</span><br><span class="line">            bs10[i] = b10[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将bytes转成string</span></span><br><span class="line">    string public str1;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">bytesToString</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        fixedByteToBytes();</span><br><span class="line">        str1 = string(bs10);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将string转成bytes</span></span><br><span class="line">    bytes public bs20;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">stringToBytes</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        bytesToString();</span><br><span class="line">        bs20 = bytes(str1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="自定义定长数组"><a href="#自定义定长数组" class="headerlink" title="自定义定长数组"></a>自定义定长数组</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract  Test &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Type[Len] name</span></span><br><span class="line">    </span><br><span class="line">    uint256[<span class="number">10</span>] public numbers = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>, <span class="number">10</span>];</span><br><span class="line">    </span><br><span class="line">    uint256 public sum;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// - 类型T，长度K的数组定义为T[K]，例如：uint [5] numbers,  byte [10] names;</span></span><br><span class="line">    <span class="comment">// - 内容可变</span></span><br><span class="line">    <span class="comment">// - 长度不可变，不支持push</span></span><br><span class="line">    <span class="comment">// - 支持length方法</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">total</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">returns</span>(<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; numbers.length; i++) &#123;</span><br><span class="line">            sum += numbers[i];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">       <span class="keyword">return</span> sum; </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setLen</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="comment">//numbers.length = 10;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">changeValue</span>(<span class="params">uint256 i , uint256 value</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        numbers[i] = value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//++++++++++++++++++++++++++++++++++</span></span><br><span class="line">    </span><br><span class="line">    bytes10 public helloworldFixed = <span class="number">0x68656c6c6f776f726c64</span>;</span><br><span class="line">    </span><br><span class="line">    byte[<span class="number">10</span>] public helloworldDynamic = [byte(<span class="number">0x68</span>), <span class="number">0x65</span>, <span class="number">0x6c</span>, <span class="number">0x6c</span>, <span class="number">0x6f</span>, <span class="number">0x77</span>, <span class="number">0x6f</span>, <span class="number">0x72</span>, <span class="number">0x6c</span>, <span class="number">0x64</span>];</span><br><span class="line">    </span><br><span class="line">    bytes public b10;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setToBytes</span>(<span class="params"></span>) <span class="title">public</span>  <span class="title">returns</span> (<span class="params">string</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (uint256 i=<span class="number">0</span>; i&lt; helloworldDynamic.length; i++) &#123;</span><br><span class="line">            byte b1 = helloworldDynamic[i];</span><br><span class="line">            b10.push(b1);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> string(b10);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="自定义不定长数组"><a href="#自定义不定长数组" class="headerlink" title="自定义不定长数组"></a>自定义不定长数组</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract  Test &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//第一种创建方式，直接赋值</span></span><br><span class="line">    uint8[] numbers = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">pushData</span>(<span class="params">uint8 num</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        numbers.push(num);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getNumbers</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint8[]</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> numbers;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//使用new关键字进行创建，赋值给storage变量数组</span></span><br><span class="line">    uint8[] numbers2;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setNumbers2</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        numbers2 = <span class="keyword">new</span> uint8[](<span class="number">7</span>);</span><br><span class="line">        numbers2.length = <span class="number">20</span>;</span><br><span class="line">        numbers2.push(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getNumbers2</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint8[]</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> numbers2;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setNumbers3</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="comment">//使用new创建的memory类型数组，无法改变长度</span></span><br><span class="line">        <span class="comment">//uint8[] memory numbers3 = new uint8[](7);</span></span><br><span class="line">        uint8[] memory numbers3;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//numbers3.push(10);     </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"><span class="comment">//pragma experimental ABIEncoderV2;</span></span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line">    <span class="comment">//定义结构之后无分号，与枚举一致</span></span><br><span class="line">    struct Student &#123;</span><br><span class="line">        string name;</span><br><span class="line">        uint age;</span><br><span class="line">        uint score;</span><br><span class="line">        string sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Student[] public Students;</span><br><span class="line">    </span><br><span class="line">        </span><br><span class="line">    <span class="comment">//两种赋值方式</span></span><br><span class="line">    Student public stu1 = Student(<span class="string">&quot;lily&quot;</span>, <span class="number">18</span>, <span class="number">90</span>, <span class="string">&quot;girl&quot;</span>);</span><br><span class="line">    Student public stu2 = Student(&#123;<span class="attr">name</span>:<span class="string">&quot;Jim&quot;</span>, <span class="attr">age</span>:<span class="number">20</span>, <span class="attr">score</span>:<span class="number">80</span>, <span class="attr">sex</span>:<span class="string">&quot;boy&quot;</span>&#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">assign</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        Students.push(stu1);</span><br><span class="line">        Students.push(stu2);</span><br><span class="line">        </span><br><span class="line">        stu1.name = <span class="string">&quot;Lily&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// function returnStudent() public view returns(Student) &#123;</span></span><br><span class="line">    <span class="comment">//     return stu1;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//使用圆括号包裹起来的类型叫做元组“tuple”</span></span><br><span class="line">    <span class="comment">//特性：1.  不可修改，2.可以容纳不同类型的数据</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">returnStudent</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">string, uint, uint, string</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (stu1.name, stu1.age, stu1.score, stu1.sex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="mapping"><a href="#mapping" class="headerlink" title="mapping"></a>mapping</h1><ol>
<li>相同的key对应的值会被覆盖</li>
<li>所有key都有值，不会抛异常，如果没有设置过某个key，会返回默认值<ol>
<li>bool ： false</li>
<li>int：0</li>
<li>string ： “”</li>
</ol>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.20</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line">    <span class="comment">//id -&gt; name</span></span><br><span class="line">    mapping(<span class="function"><span class="params">uint</span> =&gt;</span> string) public id_names;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//构造函数：</span></span><br><span class="line">    <span class="comment">//1. 对象在创建的时候，自动执行的函数，完成对象的初始化工作</span></span><br><span class="line">    <span class="comment">//2. 构造函数仅执行一次</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// function Test() public &#123;</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="title">constructor</span>(<span class="params"></span>)  <span class="title">public</span>&#123;</span><br><span class="line">        id_names[<span class="number">1</span>] = <span class="string">&quot;lily&quot;</span>;</span><br><span class="line">        id_names[<span class="number">2</span>] = <span class="string">&quot;Jim&quot;</span>;</span><br><span class="line">        id_names[<span class="number">3</span>] = <span class="string">&quot;Lily&quot;</span>;</span><br><span class="line">        id_names[<span class="number">3</span>] = <span class="string">&quot;Tom&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getNameById</span>(<span class="params">uint id</span>)  <span class="title">public</span> <span class="title">returns</span> (<span class="params">string</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//加上storage如何赋值？</span></span><br><span class="line">        string memory name = id_names[id];</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setNameById</span>(<span class="params">uint id</span>)  <span class="title">public</span> <span class="title">returns</span> (<span class="params">string</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// mapping(uint =&gt; string) memory id_name = id_names;</span></span><br><span class="line">        <span class="comment">// var ids = id_names;</span></span><br><span class="line">        id_names[id] = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// function getMapLength() public returns (uint)&#123;</span></span><br><span class="line">    <span class="comment">//     return id_names.length;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BlockChain/" rel="tag">BlockChain</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Solidity/" rel="tag">Solidity</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-IPFS"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/15/IPFS/"
    >IPFS - 01 - 搭建</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/15/IPFS/" class="article-date">
  <time datetime="2020-11-15T01:56:11.000Z" itemprop="datePublished">2020-11-15</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/BlockChain/">BlockChain</a> / <a class="article-category-link" href="/categories/BlockChain/IPFS/">IPFS</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="一、安装IPFS"><a href="#一、安装IPFS" class="headerlink" title="一、安装IPFS"></a>一、安装IPFS</h2><pre><code>&gt; * 1.下载Centos或WIndows的安装包 </code></pre>
<p><img src="/2020/11/15/IPFS/1604282306274.png" alt="1604282306274"></p>
<ul>
<li>2.上传并安装IPFS</li>
</ul>
<p><img src="/2020/11/15/IPFS/1604282593675.png" alt="1604282593675"></p>
<ul>
<li><p>3.解压并安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh install.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/15/IPFS/1604282679231.png" alt="1604282679231"></p>
</li>
</ul>
<h2 id="二、测试IPFS"><a href="#二、测试IPFS" class="headerlink" title="二、测试IPFS"></a>二、测试IPFS</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ipfs  daemon   <span class="comment">#启动ipfs服务 加入IPFS网络</span></span><br><span class="line"></span><br><span class="line">ipfs </span><br></pre></td></tr></table></figure>
<p><img src="/2020/11/15/IPFS/1604282697844.png" alt="1604282697844"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ipfs init </span><br><span class="line"></span><br><span class="line">ll -a ~/    //可以看到家目录下创建一个 .ipfs 文件夹</span><br><span class="line"></span><br><span class="line">ipfs cat /ipfs/QmQPeNsJPyVWPFDVHb77w8G42Fvo15z4bG2X8D2GhfbSXc/readme  //可以看到IPFS几个模块</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/15/IPFS/1604282774407.png" alt="1604282774407"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ipfs id </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/15/IPFS/1604282874036.png" alt="1604282874036"></p>
<p>可以通过快速开始学习IPFS的基本操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">[root@zzuxyj7 .ipfs]<span class="comment"># ipfs cat /ipfs/QmQPeNsJPyVWPFDVHb77w8G42Fvo15z4bG2X8D2GhfbSXc/quick-start</span></span><br><span class="line"><span class="comment"># 0.1 - Quick Start</span></span><br><span class="line"></span><br><span class="line">This is a <span class="built_in">set</span> of short examples with minimal explanation. It is meant as</span><br><span class="line">a <span class="string">&quot;quick start&quot;</span>.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Add a file to ipfs:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;hello world&quot;</span> &gt;hello</span><br><span class="line">  ipfs add hello</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">View it:</span><br><span class="line"></span><br><span class="line">  ipfs cat &lt;the-hash-you-got-here&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Try a directory:</span><br><span class="line"></span><br><span class="line">  mkdir foo</span><br><span class="line">  mkdir foo/bar</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;baz&quot;</span> &gt; foo/baz</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;baz&quot;</span> &gt; foo/bar/baz</span><br><span class="line">  ipfs add -r foo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">View things:</span><br><span class="line"></span><br><span class="line">  ipfs ls &lt;the-hash-here&gt;</span><br><span class="line">  ipfs ls &lt;the-hash-here&gt;/bar</span><br><span class="line">  ipfs cat &lt;the-hash-here&gt;/baz</span><br><span class="line">  ipfs cat &lt;the-hash-here&gt;/bar/baz</span><br><span class="line">  ipfs cat &lt;the-hash-here&gt;/bar</span><br><span class="line">  ipfs ls &lt;the-hash-here&gt;/baz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">References:</span><br><span class="line"></span><br><span class="line">  ipfs refs &lt;the-hash-here&gt;</span><br><span class="line">  ipfs refs -r &lt;the-hash-here&gt;</span><br><span class="line">  ipfs refs --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Get:</span><br><span class="line"></span><br><span class="line">  ipfs get &lt;the-hash-here&gt; -o foo2</span><br><span class="line">  diff foo foo2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Objects:</span><br><span class="line"></span><br><span class="line">  ipfs object get &lt;the-hash-here&gt;</span><br><span class="line">  ipfs object get &lt;the-hash-here&gt;/foo2</span><br><span class="line">  ipfs object --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Pin + GC:</span><br><span class="line"></span><br><span class="line">  ipfs pin add &lt;the-hash-here&gt;</span><br><span class="line">  ipfs repo gc</span><br><span class="line">  ipfs ls &lt;the-hash-here&gt;</span><br><span class="line">  ipfs pin rm &lt;the-hash-here&gt;</span><br><span class="line">  ipfs repo gc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Daemon:</span><br><span class="line"></span><br><span class="line">  ipfs daemon  (<span class="keyword">in</span> another terminal)</span><br><span class="line">  ipfs id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Network:</span><br><span class="line"></span><br><span class="line">  (must be online)</span><br><span class="line">  ipfs swarm peers</span><br><span class="line">  ipfs id</span><br><span class="line">  ipfs cat &lt;hash-of-remote-object&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mount:</span><br><span class="line"></span><br><span class="line">  (warning: fuse is finicky!)</span><br><span class="line">  ipfs mount</span><br><span class="line">  <span class="built_in">cd</span> /ipfs/&lt;the-hash-here&gt;</span><br><span class="line">  ls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Tool:</span><br><span class="line"></span><br><span class="line">  ipfs version</span><br><span class="line">  ipfs update</span><br><span class="line">  ipfs commands</span><br><span class="line">  ipfs config --<span class="built_in">help</span></span><br><span class="line">  open http://localhost:5001/webui</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Browse:</span><br><span class="line"></span><br><span class="line">  WebUI:</span><br><span class="line"></span><br><span class="line">    http://localhost:5001/webui</span><br><span class="line"></span><br><span class="line">  video:</span><br><span class="line"></span><br><span class="line">    http://localhost:8080/ipfs/QmVc6zuAneKJzicnJpfrqCH9gSy6bz54JhcypfJYhGUFQu/play<span class="comment">#/ipfs/QmTKZgRNwDNZwHtJSjCp6r5FYefzpULfy37JvMt9DwvXse</span></span><br><span class="line"></span><br><span class="line">  images:</span><br><span class="line"></span><br><span class="line">    http://localhost:8080/ipfs/QmZpc3HvfjEXvLWGQPWbHk3AjD5j8NEN4gmFN8Jmrd5g83/cs</span><br><span class="line"></span><br><span class="line">  markdown renderer app:</span><br><span class="line"></span><br><span class="line">    http://localhost:8080/ipfs/QmX7M9CiYXjVeFnkfVGf3y5ixTZ2ACeSGyL1vBJY1HvQPp/mdown</span><br><span class="line"></span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BlockChain/" rel="tag">BlockChain</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IPFS/" rel="tag">IPFS</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-Hexo-本地图片-md"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/13/Hexo-%E6%9C%AC%E5%9C%B0%E5%9B%BE%E7%89%87-md/"
    >Hexo_本地图片如何上传到Github</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/13/Hexo-%E6%9C%AC%E5%9C%B0%E5%9B%BE%E7%89%87-md/" class="article-date">
  <time datetime="2020-11-13T09:49:25.000Z" itemprop="datePublished">2020-11-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Hexo/">Hexo</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h2><ul>
<li>首先进行配置文件的修改， _config.yml(不是主题配置文件)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post_asset_folder: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<img src="/2020/11/13/Hexo-%E6%9C%AC%E5%9C%B0%E5%9B%BE%E7%89%87-md/1.png" alt="修改配置项"><h2 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-asset-image --save</span><br></pre></td></tr></table></figure>
<img src="/2020/11/13/Hexo-%E6%9C%AC%E5%9C%B0%E5%9B%BE%E7%89%87-md/2.png" alt="install"><h2 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h2></li>
<li>通过命令，创建一篇新的文章时候，自动在source/_post/新建对应文件名称的文件夹（为了避免有时候文章中并没有图片，可以手动创建md文件，需要图片在创建文件夹即可）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new test.md</span><br></pre></td></tr></table></figure></li>
<li>进入source/_post/下即可看到对应创建的文件和文件夹<h2 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean  <span class="comment">#清除</span></span><br><span class="line">hexo ge    <span class="comment">#生成静态资源 ， 此时可以通过输出信息看到对应的图片名称信息，基本就完成了</span></span><br><span class="line">hexo s     <span class="comment">#本地查看是否生效</span></span><br></pre></td></tr></table></figure>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2></li>
<li>在md文件中，图片的路径可以写一下两种方式都可以load到图片的路径<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">![test1](./1.png)</span><br><span class="line">![test1](./<span class="built_in">test</span>/2.png)</span><br></pre></td></tr></table></figure>
</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-git"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/13/git/"
    >Git基本用法</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/13/git/" class="article-date">
  <time datetime="2020-11-13T09:49:25.000Z" itemprop="datePublished">2020-11-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Git/">Git</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="Git-入门"><a href="#Git-入门" class="headerlink" title="Git 入门"></a>Git 入门</h2><pre><code> 默认linux自带Git , 可以进行更新。</code></pre>
<hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install git -y <span class="comment">#安装git </span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config </span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@zzuxyj7 ~]<span class="comment"># git config </span></span><br><span class="line">用法：git config [选项]</span><br><span class="line"></span><br><span class="line">配置文件位置</span><br><span class="line">    --global              使用全局配置文件</span><br><span class="line">    --system              使用系统级配置文件</span><br><span class="line">    --<span class="built_in">local</span>               使用版本库级配置文件</span><br><span class="line">    -f, --file &lt;文件&gt;     使用指定的配置文件</span><br><span class="line">    --blob &lt;blob-id&gt;      <span class="built_in">read</span> config from given blob object</span><br><span class="line"></span><br><span class="line">操作</span><br><span class="line">    --get                 获取值：name [value-regex]</span><br><span class="line">    --get-all             获得所有的值：key [value-regex]</span><br><span class="line">    --get-regexp          根据正则表达式获得值：name-regex [value-regex]</span><br><span class="line">    --replace-all         替换所有匹配的变量：name value [value_regex]</span><br><span class="line">    --add                 添加一个新的变量：name value</span><br><span class="line">    --<span class="built_in">unset</span>               删除一个变量：name [value-regex]</span><br><span class="line">    --unset-all           删除所有匹配项：name [value-regex]</span><br><span class="line">    --rename-section      重命名小节：old-name new-name</span><br><span class="line">    --remove-section      删除一个小节：name</span><br><span class="line">    -l, --list            列出所有</span><br><span class="line">    -e, --edit            打开一个编辑器</span><br><span class="line">    --get-color &lt;slot&gt;    找到配置的颜色：[默认]</span><br><span class="line">    --get-colorbool &lt;slot&gt;</span><br><span class="line">                          找到颜色设置：[stdout-is-tty]</span><br><span class="line">类型</span><br><span class="line">    --bool                值是 <span class="string">&quot;true&quot;</span> 或 <span class="string">&quot;false&quot;</span></span><br><span class="line">    --int                 值是十进制数</span><br><span class="line">    --bool-or-int         值是 --bool or --int</span><br><span class="line">    --path                值是一个路径（文件或目录名）</span><br><span class="line"></span><br><span class="line">其它</span><br><span class="line">    -z, --null            终止值是NUL字节</span><br><span class="line">    --includes            查询时参照 include 指令递归查找</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="第一步-首先配置Git的本地用户信息，用于提交到本地仓库认证，否则不予提交"><a href="#第一步-首先配置Git的本地用户信息，用于提交到本地仓库认证，否则不予提交" class="headerlink" title="第一步 首先配置Git的本地用户信息，用于提交到本地仓库认证，否则不予提交"></a>第一步 首先配置Git的本地用户信息，用于提交到本地仓库认证，否则不予提交</h2><ul>
<li>配置是哪个用户使用git</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@zzuxyj7 ~]<span class="comment"># git config --global user.email &quot;aayxyj@163.com&quot;</span></span><br><span class="line"></span><br><span class="line">[root@zzuxyj7 ~]<span class="comment"># git config --global user.name &quot;zzuxyj&quot;</span></span><br><span class="line"></span><br><span class="line">[root@zzuxyj7 ~]<span class="comment"># git config --global color.ui true  //高亮</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@zzuxyj7 ~]<span class="comment"># git config --list</span></span><br><span class="line">user.name=zzuxyj</span><br><span class="line">user.email=aayxyj@163.com</span><br><span class="line">color.ui=<span class="literal">true</span></span><br><span class="line">[root@zzuxyj7 ~]<span class="comment"># cat .gitconfig </span></span><br><span class="line">[user]</span><br><span class="line">    name = zzuxyj</span><br><span class="line">    email = aayxyj@163.com</span><br><span class="line">[color]</span><br><span class="line">    ui = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="第二步-创建文件夹并进行初始化，该目录即为本地仓库"><a href="#第二步-创建文件夹并进行初始化，该目录即为本地仓库" class="headerlink" title="第二步 创建文件夹并进行初始化，该目录即为本地仓库"></a>第二步 创建文件夹并进行初始化，该目录即为本地仓库</h2><ul>
<li>创建本地仓库<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir gitdata <span class="comment">#创建目录</span></span><br><span class="line"><span class="built_in">cd</span> gitdata    <span class="comment">#进入目录</span></span><br><span class="line">git  init  <span class="comment">#初始化仓库  初始化空的 Git 版本库于 /root/gitdata/.git/</span></span><br></pre></td></tr></table></figure></li>
<li>本地仓库信息<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">隐藏文件介绍︰</span><br><span class="line">branches <span class="comment"># 分支目录</span></span><br><span class="line">config<span class="comment"># 定义项目特有的配置选项</span></span><br><span class="line">description<span class="comment"># 仅供git web程序使用</span></span><br><span class="line">HEAD <span class="comment">#指示当前的分支</span></span><br><span class="line">hooks <span class="comment"># 包含git钩子文件</span></span><br><span class="line">info <span class="comment">#包含一个全局排除文件(exclude文件)</span></span><br><span class="line">objects <span class="comment"># 存放所有数据内容，有info和pack两个子文件夹</span></span><br><span class="line">refrs <span class="comment"># 存放指向数据(分支)的提交对象的指针</span></span><br><span class="line">index <span class="comment">#保存暂存区信息，在执行git init的时候，这个文件还没有</span></span><br></pre></td></tr></table></figure></li>
<li>查看初始的git版本库的结构<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@zzuxyj7 gitdata]<span class="comment"># tree .git/</span></span><br><span class="line">.git/</span><br><span class="line">├── branches</span><br><span class="line">├── config</span><br><span class="line">├── description</span><br><span class="line">├── HEAD</span><br><span class="line">├── hooks</span><br><span class="line">│   ├── applypatch-msg.sample</span><br><span class="line">│   ├── commit-msg.sample</span><br><span class="line">│   ├── post-update.sample</span><br><span class="line">│   ├── pre-applypatch.sample</span><br><span class="line">│   ├── pre-commit.sample</span><br><span class="line">│   ├── prepare-commit-msg.sample</span><br><span class="line">│   ├── pre-push.sample</span><br><span class="line">│   ├── pre-rebase.sample</span><br><span class="line">│   └── update.sample</span><br><span class="line">├── info</span><br><span class="line">│   └── exclude</span><br><span class="line">├── objects</span><br><span class="line">│   ├── info</span><br><span class="line">│   └── pack</span><br><span class="line">└── refs</span><br><span class="line">    ├── heads</span><br><span class="line">    └── tags</span><br></pre></td></tr></table></figure>
<h2 id="第三步-开始进行代码或文件的CURD操作"><a href="#第三步-开始进行代码或文件的CURD操作" class="headerlink" title="第三步 开始进行代码或文件的CURD操作"></a>第三步 开始进行代码或文件的CURD操作</h2></li>
<li>提交为空，但是存在尚未跟踪的文件（使用 “git add” 建立跟踪）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zzuxyj7 gitdata]<span class="comment"># git add 1.go  #跟踪</span></span><br><span class="line">[root@zzuxyj7 gitdata]<span class="comment"># git status    #查看git仓库的状态，可以看到跟踪的文件</span></span><br></pre></td></tr></table></figure></li>
<li>提交跟踪文件后，需要删除时候<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@zzuxyj7 gitdata]<span class="comment"># git rm 1.go   #删除跟踪</span></span><br><span class="line">rm <span class="string">&#x27;1.go&#x27;</span></span><br><span class="line">[root@zzuxyj7 gitdata]<span class="comment"># git status    #查看git仓库的状态，文件已经被删除</span></span><br></pre></td></tr></table></figure></li>
<li>建立文件跟踪后，如果需要提交到本地仓库还是需要进行commit提交才可以到本地仓库<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@zzuxyj7 gitdata]<span class="comment"># git commit -m &quot;Test&quot;</span></span><br><span class="line">[master（根提交） b58f049] Test</span><br><span class="line"> 1 file changed, 0 insertions(+), 0 deletions(-)</span><br><span class="line"> create mode 100644 1.go</span><br></pre></td></tr></table></figure>
<h2 id="注-：常用的git命令"><a href="#注-：常用的git命令" class="headerlink" title="注 ：常用的git命令"></a>注 ：常用的git命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">1.git init<span class="comment">#初始化仓库把一个目录初始化为版本仓库〈可以是空的目录也可以是带内容的目录)</span></span><br><span class="line">2.git status<span class="comment">#查看当前仓库的状态</span></span><br><span class="line">3.git add file<span class="comment">#添加文件到暂存区</span></span><br><span class="line">4.git add .或者git add * <span class="comment">#添加当前所有的文件到暂存区</span></span><br><span class="line">5.git rm --cached<span class="comment">#撤出暂存区</span></span><br><span class="line">6.git rm -f<span class="comment">#同时删除工作目录和暂存区的文件</span></span><br><span class="line">7.git commit -m<span class="comment">#从缓存区提交到本地仓库</span></span><br><span class="line">8.git mv old-filename new-filename<span class="comment">#直接更改文件名称更改完直接commit提交即可</span></span><br><span class="line">9.git diff<span class="comment">#默认比对工作目录和暂存区有什么不同</span></span><br><span class="line">10.git diff --cached <span class="comment">#比对暂存区域和本地仓库</span></span><br><span class="line">11.<span class="comment">#如果某个文件已经被仓库管理,如果在更改此文件直接需要一条命令提交即可</span></span><br><span class="line">	git commit -am <span class="string">&quot;add newfile&quot;</span></span><br><span class="line">12.git <span class="built_in">log</span><span class="comment">#查看历史提交过的信息</span></span><br><span class="line">	-p <span class="comment">#查看具体的改动</span></span><br><span class="line">	-1<span class="comment">#查看最近一次</span></span><br><span class="line">13.git reset --hard 295e997 <span class="comment">#回滚数据到某一个提交</span></span><br><span class="line">14.git <span class="built_in">log</span> --oneline --decorate<span class="comment">#查看当前指针的指向</span></span><br><span class="line">15.git <span class="built_in">log</span> --reflog <span class="comment">#查看所有镜像</span></span><br><span class="line">15.git branch<span class="comment">#查看分支  * 号在那就在那个分支上</span></span><br><span class="line">16.git branch testing<span class="comment">#创建一个测试分支</span></span><br><span class="line">17.git checkout testing<span class="comment">#切换到测试分支</span></span><br><span class="line">18.git checkout -b testing<span class="comment">#创建并切换到testing分支</span></span><br><span class="line">19.git tag<span class="comment">#打标签</span></span><br><span class="line">	-d删除标签</span><br><span class="line">	git tag -d v1.0  <span class="comment">#删除标签</span></span><br><span class="line">	git tag -a <span class="string">&quot;v2.0&quot;</span> -m <span class="string">&quot;xxx&quot;</span>  <span class="comment">#打标签</span></span><br><span class="line">	git show v1.0  <span class="comment">#查看版本信息</span></span><br><span class="line"></span><br><span class="line">20.git  remote add origin git@github.com:ayxyj/ayxyj.github.io.git  //添加远程仓库</span><br><span class="line"></span><br><span class="line">	git remote  <span class="comment">#查看远程仓库</span></span><br><span class="line"></span><br><span class="line">21.git <span class="built_in">clone</span> url </span><br><span class="line"></span><br><span class="line">	标签也是指向了一次commit提交，是一个里程碑式的标签，回滚打标签直接加标签号，不需要加唯一字符串不好记</span><br><span class="line">	[root@git git_data]<span class="comment"># git tag -a v1.0 -m &quot;aaa bbb master tesing version v1.0”#  -a指定标签名字  -m指定说明文字</span></span><br><span class="line">	[root@git git_data]<span class="comment"># git tagv1.0</span></span><br><span class="line">	[root@git git_data]<span class="comment"># git tag -a v2.0 dbead4c  -m &quot;add bbb version v2.0&quot;  #指定某一次的提交</span></span><br><span class="line">	为标签</span><br><span class="line">	[root@git git_data]<span class="comment"># git show v1.0  #查看v1.0的信息git show加标签查看</span></span><br><span class="line">	[root@git git_data]<span class="comment"># git reset --hard v2.0#直接还原数据到v2.0</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="最后如何把本地仓库推送到远程仓库步骤："><a href="#最后如何把本地仓库推送到远程仓库步骤：" class="headerlink" title="最后如何把本地仓库推送到远程仓库步骤："></a>最后如何把本地仓库推送到远程仓库步骤：</h2><ul>
<li><p>第一种方式每次手动写远程仓库地址</p>
</li>
<li><p>1.首先先把本地代码提交到本地仓库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add . </span><br><span class="line">git commit -m <span class="string">&quot;add file !&quot;</span> </span><br><span class="line">git  commit -am <span class="string">&quot;add file !&quot;</span> </span><br></pre></td></tr></table></figure>
</li>
<li><p>2.其次再把本地仓库的代码提交到远程仓库上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git remote add gocode git@github.com:ayxyj/ayxyj.github.io.git  <span class="comment">#添加远程仓库</span></span><br><span class="line">git push -u gocode master <span class="comment">#第一次提交到远程仓库的master分支上</span></span><br><span class="line">git push gocode master <span class="comment">#之后提交</span></span><br></pre></td></tr></table></figure></li>
<li><p>3.删除本地分支和远程分支</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git branch -d master <span class="comment">#删除本地分支、注意删除时候应该切换到其他分支才可以删除分支</span></span><br><span class="line">git push gocode --delete master <span class="comment">#删除远程仓库下的mater分支</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>4.合并本地分支和远程分支</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">基本流程</span><br><span class="line">0.查看远程仓库</span><br><span class="line">git remote -v</span><br><span class="line"></span><br><span class="line">1.本地创建一个与新分支并且关联远程分支</span><br><span class="line">git checkout -b dev gocode/dev </span><br><span class="line">这时 dev 已经和远程的 gocode/dev 一致了。</span><br><span class="line"></span><br><span class="line">同上1.查看到远程有一个叫gocode的仓库，我们可以使用如下命令从gocode远程仓库获取最新版本的代码。</span><br><span class="line">git fetch origin master:temp</span><br><span class="line">上面代码的意思是：从远程的gocode仓库的master分支下载到本地，并新建一个temp分支。</span><br><span class="line"></span><br><span class="line">2.查看temp分支与本地原有分支的不同</span><br><span class="line">git diff temp</span><br><span class="line"></span><br><span class="line">3. 切换回本地的 master 版本</span><br><span class="line">git checkout master </span><br><span class="line"></span><br><span class="line">4. 将本地的 dev 合并到 master</span><br><span class="line">git merge dev </span><br><span class="line"></span><br><span class="line">5. 将本地的 master 推到远程</span><br><span class="line">git push gocode master </span><br><span class="line"></span><br><span class="line">6. 将远程的 dev 版本删除</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二种方式在配置文件中配置远程仓库的地址（需要做ssh认证）</p>
<ul>
<li>生成ssh公私钥<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">&quot;aayxyj@163.com&quot;</span></span><br><span class="line">cat ~/.ssh/id_rsa.pub <span class="comment">#将查看到的公钥在github的个人设置中新建ssh密码填入即可</span></span><br></pre></td></tr></table></figure></li>
<li>在配置文件中添加信息<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  <span class="built_in">type</span>: git</span><br><span class="line">  repo: 这里填刚记录的github <span class="built_in">clone</span>仓库地址</span><br><span class="line">  branch: master <span class="comment">#上传到那个分支上</span></span><br></pre></td></tr></table></figure></li>
<li>接下来就可以直接push即可</li>
</ul>
</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Git/" rel="tag">Git</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-sublime配置"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/13/sublime%E9%85%8D%E7%BD%AE/"
    >Sublime 乱码问题及插件安装</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/13/sublime%E9%85%8D%E7%BD%AE/" class="article-date">
  <time datetime="2020-11-13T02:21:29.000Z" itemprop="datePublished">2020-11-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Sublime/">Sublime</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="sublime-解决中文乱码问题"><a href="#sublime-解决中文乱码问题" class="headerlink" title="sublime 解决中文乱码问题"></a>sublime 解决中文乱码问题</h2><h3 id="1-通过快捷键-ctrl-进入命令行，并输入以下命令然后回车"><a href="#1-通过快捷键-ctrl-进入命令行，并输入以下命令然后回车" class="headerlink" title="1.通过快捷键 ctrl + ~ 进入命令行，并输入以下命令然后回车"></a>1.通过快捷键 ctrl + ~ 进入命令行，并输入以下命令然后回车</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import urllib.request,os,hashlib; h = <span class="string">&#x27;7183a2d3e96f11eeadd761d777e62404e330c659d4bb41d3bdf022e94cab3cd0&#x27;</span>; pf = <span class="string">&#x27;Package Control.sublime-package&#x27;</span>; ipp = sublime.installed_packages_path(); urllib.request.install_opener( urllib.request.build_opener( urllib.request.ProxyHandler()) ); by = urllib.request.urlopen( <span class="string">&#x27;http://sublime.wbond.net/&#x27;</span> + pf.replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;%20&#x27;</span>)).<span class="built_in">read</span>(); dh = hashlib.sha256(by).hexdigest(); <span class="built_in">print</span>(<span class="string">&#x27;Error validating download (got %s instead of %s), please try manual install&#x27;</span> % (dh, h)) <span class="keyword">if</span> dh != h <span class="keyword">else</span> open(os.path.join( ipp, pf), <span class="string">&#x27;wb&#x27;</span> ).write(by)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>这是由于网络访问网站<a target="_blank" rel="noopener" href="http://packagecontrol.io/%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E6%88%90%E5%8A%9F%E5%AF%BC%E8%87%B4%E7%9A%84%EF%BC%8C%E6%89%80%E4%BB%A5%E7%A1%AE%E4%BF%9D%E8%83%BD%E5%A4%9F%E8%AE%BF%E9%97%AE%E8%AF%A5%E7%BD%91%E5%9D%80%E6%97%B6%E6%89%8D%E8%83%BD%E7%BB%A7%E7%BB%AD%E5%AE%89%E8%A3%85%EF%BC%8C%E8%BF%99%E9%87%8C%E6%88%91%E7%9B%B4%E6%8E%A5%E9%80%9A%E8%BF%87%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%E7%9A%84%E6%96%B9%E5%BC%8F%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E4%BA%86%EF%BC%8C%E4%BD%86%E6%98%AF%E5%8F%88%E5%87%BA%E7%8E%B0%E4%BA%86%E4%B8%8B%E9%9D%A2%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%9A">http://packagecontrol.io/无法访问成功导致的，所以确保能够访问该网址时才能继续安装，这里我直接通过科学上网的方式就可以访问了，但是又出现了下面的问题：</a></p>
</li>
<li><p>根据报错信息将该命令中的str1 字符串换成str2再重试即可发现成功</p>
</li>
</ul>
<h3 id="2-安装ConvertToUTF8。"><a href="#2-安装ConvertToUTF8。" class="headerlink" title="2.安装ConvertToUTF8。"></a>2.安装ConvertToUTF8。</h3><ul>
<li><p>通过快捷键 Ctrl + shift + P，然后在弹出的输入框输入 install，选择Package Control：install Package回车</p>
</li>
<li><p>在出现的插件命令行搜索ConvertToUTF8，选中回车进行插件安装</p>
</li>
<li><p>重启Sublime Text 3后再次打开之前中文乱码的文件发现，中文能够正常显示</p>
</li>
</ul>
<h2 id="sublime-主题和字体"><a href="#sublime-主题和字体" class="headerlink" title="sublime 主题和字体"></a>sublime 主题和字体</h2><ul>
<li><p>通过快捷键 Ctrl + shift + P ，然后在弹出的输入框输入 install，选择Package Control：install Package回车</p>
</li>
<li><p>在出现的插件命令行搜索Themes：ayu/edge  Font：Consoles</p>
</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Sublime/" rel="tag">Sublime</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2018-2020
        <i class="ri-heart-fill heart_icon"></i> Syraer
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>Visitors:<span id="busuanzi_value_site_uv"></span></s>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>Views:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
        <li>
          <a href="http://www.beian.gov.cn/portal/index" target="_black" rel="nofollow">皖ICP备18009389号-1</a>
        </li>
        
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1279416140&amp;web_id=1279416140'></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Syraer&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>

<!-- Katex -->

<!-- busuanzi  -->


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


    
  </div>
</body>

</html>